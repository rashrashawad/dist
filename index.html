<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al-Moazin Digital Clock - Ø³Ø§Ø¹Ø© Ø§Ù„Ù…Ø¤Ø°Ù†</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Literata:ital,opsz,wght@0,7..72,200..900;1,7..72,200..900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Literata', 'serif'],
                        body: ['Literata', 'serif'],
                        headline: ['Literata', 'serif'],
                        mono: ['monospace'],
                    },
                }
            }
        }
    </script>
    <style>
        :root {
            --background: 220 19% 14%;
            --foreground: 43 33% 92%;
            --card: 220 19% 18%;
            --card-foreground: 43 33% 92%;
            --popover: 220 19% 14%;
            --popover-foreground: 43 33% 92%;
            --primary: 240 71% 27%;
            --primary-foreground: 43 33% 92%;
            --secondary: 220 15% 30%;
            --secondary-foreground: 43 33% 92%;
            --muted: 220 15% 30%;
            --muted-foreground: 220 9% 65%;
            --accent: 43 74% 49%;
            --accent-foreground: 220 19% 14%;
            --destructive: 0 84% 60%;
            --destructive-foreground: 43 33% 92%;
            --border: 220 15% 30%;
            --input: 220 15% 30%;
            --ring: 43 74% 49%;
            --radius: 0.5rem;
        }
        body {
            font-family: 'Literata', serif;
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
        }
        .accordion-content.open {
            max-height: 2000px;
        }
        .sheet-overlay {
            position: fixed;
            inset: 0;
            z-index: 50;
            background-color: rgba(0, 0, 0, 0.5);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .sheet-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        .sheet-content {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 50;
            width: 100%;
            max-width: 28rem;
            background-color: hsl(var(--card));
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.3);
            transform: translateX(100%);
            transition: transform 0.3s;
        }
        .sheet-content.open {
            transform: translateX(0);
        }
        .slider {
            position: relative;
            display: flex;
            width: 100%;
            touch-action: none;
            user-select: none;
            align-items: center;
        }
        .slider-track {
            position: relative;
            height: 2px;
            width: 100%;
            background-color: hsl(var(--muted));
            border-radius: 9999px;
        }
        .slider-range {
            position: absolute;
            height: 100%;
            background-color: hsl(var(--primary));
        }
        .slider-thumb {
            display: block;
            width: 20px;
            height: 20px;
            background-color: hsl(var(--primary));
            border-radius: 9999px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        /* Settings Panel Styles */
        #settings-panel {
            background-color: hsl(220, 19%, 18%) !important;
            color: hsl(43, 33%, 92%) !important;
        }
        #settings-content {
            background-color: hsl(220, 19%, 18%) !important;
            color: hsl(43, 33%, 92%) !important;
        }
        #settings-content input[type="text"],
        #settings-content input[type="number"],
        #settings-content input[type="time"],
        #settings-content input[type="file"],
        #settings-content select {
            background-color: hsl(220, 15%, 30%) !important;
            color: hsl(43, 33%, 92%) !important;
            border-color: hsl(220, 15%, 30%) !important;
        }
        #settings-content input[type="text"]:focus,
        #settings-content input[type="number"]:focus,
        #settings-content input[type="time"]:focus,
        #settings-content select:focus {
            outline: 2px solid hsl(43, 74%, 49%);
            outline-offset: 2px;
        }
        #settings-content label {
            color: hsl(43, 33%, 92%) !important;
        }
        #settings-content h3 {
            color: hsl(43, 33%, 92%) !important;
        }
        #settings-content .text-muted-foreground {
            color: hsl(220, 9%, 65%) !important;
        }
        #settings-content .border-b {
            border-color: hsl(220, 15%, 30%) !important;
        }
        #settings-content .border-t {
            border-color: hsl(220, 15%, 30%) !important;
        }
        #save-settings {
            background-color: hsl(240, 71%, 27%) !important;
            color: hsl(43, 33%, 92%) !important;
        }
        #save-settings:hover {
            background-color: hsl(240, 71%, 35%) !important;
        }
    </style>
</head>
<body class="font-sans antialiased">
    <audio id="audioRef" class="hidden"></audio>
    
    <!-- Main Container -->
    <div id="app-container"></div>
    
    <!-- Settings Panel -->
    <div id="settings-overlay" class="sheet-overlay"></div>
    <div id="settings-panel" class="sheet-content flex flex-col">
        <div class="p-6 border-b">
            <h2 class="text-2xl font-bold">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø§Ø¹Ø©</h2>
            <p class="text-sm text-muted-foreground mt-1">Ù‚Ù… Ø¨ØªØ®ØµÙŠØµ Ù…Ø¸Ù‡Ø± ÙˆÙ…Ø¹Ù„ÙˆÙ…Ø§Øª Ø´Ø§Ø´Ø© Ø§Ù„Ø³Ø§Ø¹Ø©.</p>
        </div>
        <div class="flex-1 overflow-y-auto p-6" id="settings-content">
            <!-- Settings content will be generated by JS -->
        </div>
        <div class="p-6 border-t space-y-3">
            <button id="save-settings" class="w-full bg-primary text-primary-foreground px-4 py-2 rounded-md hover:bg-primary/90">Ø­ÙØ¸ ÙˆØ¥ØºÙ„Ø§Ù‚</button>
            <button id="update-prayer-times" class="w-full bg-secondary text-secondary-foreground px-4 py-2 rounded-md hover:bg-secondary/90">ØªØ­Ø¯ÙŠØ« Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©</button>
        </div>
    </div>

    <script>
        // ==================== CONSTANTS ====================
        const prayerNames = {
            fajr: 'Ø§Ù„ÙØ¬Ø±',
            dhuhr: 'Ø§Ù„Ø¸Ù‡Ø±',
            asr: 'Ø§Ù„Ø¹ØµØ±',
            maghrib: 'Ø§Ù„Ù…ØºØ±Ø¨',
            isha: 'Ø§Ù„Ø¹Ø´Ø§Ø¡',
        };

        const PRAYER_ORDER = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'];

        const hadiths = [
            "Â«Ø¥ÙÙ†ÙÙ‘Ù…ÙØ§ Ø§Ù„Ø£ÙØ¹Ù’Ù…ÙØ§Ù„Ù Ø¨ÙØ§Ù„Ù†ÙÙ‘ÙŠÙÙ‘Ø§ØªÙØŒ ÙˆÙØ¥ÙÙ†ÙÙ‘Ù…ÙØ§ Ù„ÙÙƒÙÙ„ÙÙ‘ Ø§Ù…Ù’Ø±ÙØ¦Ù Ù…ÙØ§ Ù†ÙÙˆÙÙ‰Â»",
            "Â«Ø§Ù„Ø¯ÙÙ‘ÙŠÙ†Ù Ø§Ù„Ù†ÙÙ‘ØµÙÙŠØ­ÙØ©ÙÂ»",
            "Â«Ù„Ø§ ÙŠÙØ¤Ù’Ù…ÙÙ†Ù Ø£ÙØ­ÙØ¯ÙÙƒÙÙ…Ù’ØŒ Ø­ÙØªÙÙ‘Ù‰ ÙŠÙØ­ÙØ¨ÙÙ‘ Ù„ÙØ£ÙØ®ÙÙŠÙ‡Ù Ù…ÙØ§ ÙŠÙØ­ÙØ¨ÙÙ‘ Ù„ÙÙ†ÙÙÙ’Ø³ÙÙ‡ÙÂ»",
            "Â«Ù…ÙÙ†Ù’ Ø³ÙÙ„ÙÙƒÙ Ø·ÙØ±ÙÙŠÙ‚Ù‹Ø§ ÙŠÙÙ„Ù’ØªÙÙ…ÙØ³Ù ÙÙÙŠÙ‡Ù Ø¹ÙÙ„Ù’Ù…Ù‹Ø§ØŒ Ø³ÙÙ‡ÙÙ‘Ù„Ù Ø§Ù„Ù„Ù‡Ù Ù„ÙÙ‡Ù Ø·ÙØ±ÙÙŠÙ‚Ù‹Ø§ Ø¥ÙÙ„ÙÙ‰ Ø§Ù„Ù’Ø¬ÙÙ†ÙÙ‘Ø©ÙÂ»",
            "Â«Ø§Ù„Ù’ÙƒÙÙ„ÙÙ…ÙØ©Ù Ø§Ù„Ø·ÙÙ‘ÙŠÙÙ‘Ø¨ÙØ©Ù ØµÙØ¯ÙÙ‚ÙØ©ÙŒÂ»",
            "Â«ØªÙØ¨ÙØ³ÙÙ‘Ù…ÙÙƒÙ ÙÙÙŠ ÙˆÙØ¬Ù’Ù‡Ù Ø£ÙØ®ÙÙŠÙƒÙ Ù„ÙÙƒÙ ØµÙØ¯ÙÙ‚ÙØ©ÙŒÂ»",
            "Â«Ø®ÙÙŠÙ’Ø±ÙÙƒÙÙ…Ù’ Ù…ÙÙ†Ù’ ØªÙØ¹ÙÙ„ÙÙ‘Ù…Ù Ø§Ù„Ù’Ù‚ÙØ±Ù’Ø¢Ù†Ù ÙˆÙØ¹ÙÙ„ÙÙ‘Ù…ÙÙ‡ÙÂ»"
        ];

        const azkarAfterPrayer = [
            "Ø£ÙØ³Ù’Ù€ØªÙØºÙ’ÙÙØ±Ù Ø§Ù„Ù„Ù‡ØŒ Ø£ÙØ³Ù’Ù€ØªÙØºÙ’ÙÙØ±Ù Ø§Ù„Ù„Ù‡ØŒ Ø£ÙØ³Ù’Ù€ØªÙØºÙ’ÙÙØ±Ù Ø§Ù„Ù„Ù‡.\n\nØ§Ù„Ù„Ù‘Ù‡ÙÙ€Ù…ÙÙ‘ Ø£ÙÙ†Ù’Ù€ØªÙ Ø§Ù„Ø³ÙÙ‘Ù„Ø§Ù…Ù ØŒ ÙˆÙÙ…ÙÙ€Ù†Ù’ÙƒÙ Ø§Ù„Ø³ÙÙ‘Ù„Ø§Ù… ØŒ ØªÙØ¨Ø§Ø±ÙÙƒÙ’ØªÙ ÙŠØ§ Ø°Ø§ Ø§Ù„Ø¬ÙÙ€Ù„Ø§Ù„Ù ÙˆÙØ§Ù„Ø¥ÙÙƒÙ’Ù€Ø±Ø§Ù… .",
            "Ù„Ø§ Ø¥Ù„Ù‡Ù Ø¥Ù„Ø§Ù‘ Ø§Ù„Ù„Ù‘Ù‡Ù ÙˆØ­Ø¯ÙÙ‡Ù Ù„Ø§ Ø´Ø±ÙŠÙƒÙ Ù„Ù‡ÙØŒ Ù„Ù‡Ù Ø§Ù„Ù…ÙÙ€Ù„Ù’ÙƒÙ ÙˆÙ„Ù‡Ù Ø§Ù„Ø­ÙÙ…Ù’Ø¯ØŒ ÙˆÙ‡ÙˆÙ Ø¹Ù„Ù‰ ÙƒÙ„Ù‘ Ø´ÙÙŠØ¡Ù Ù‚ÙØ¯ÙŠØ±ØŒ\n\nØ§Ù„Ù„Ù‘Ù‡ÙÙ€Ù…ÙÙ‘ Ù„Ø§ Ù…Ø§Ù†ÙØ¹Ù Ù„ÙÙ…Ø§ Ø£ÙØ¹Ù’Ø·ÙÙ€ÙŠÙ’ØªØŒ ÙˆÙÙ„Ø§ Ù…ÙØ¹Ù’Ø·ÙÙ€ÙŠÙ Ù„ÙÙ…Ø§ Ù…ÙÙ†ÙÙ€Ø¹Ù’ØªØŒ ÙˆÙÙ„Ø§ ÙŠÙÙ†Ù’ÙÙÙ€Ø¹Ù Ø°Ø§ Ø§Ù„Ø¬ÙÙ€Ø¯ÙÙ‘ Ù…ÙÙ†Ù’Ù€ÙƒÙ Ø§Ù„Ø¬ÙÙ€Ø¯.",
            "Ù„Ø§ Ø¥Ù„Ù‡Ù Ø¥Ù„Ø§Ù‘ Ø§Ù„Ù„Ù‘Ù‡ØŒ ÙˆØ­Ø¯ÙÙ‡Ù Ù„Ø§ Ø´Ø±ÙŠÙƒÙ Ù„Ù‡ÙØŒ Ù„Ù‡Ù Ø§Ù„Ù…Ù„ÙƒÙ ÙˆÙ„Ù‡Ù Ø§Ù„Ø­ÙÙ…Ø¯ØŒ ÙˆÙ‡ÙˆÙ Ø¹Ù„Ù‰ ÙƒÙ„Ù‘ Ø´ÙŠØ¡Ù Ù‚Ø¯ÙŠØ±ØŒ\n\nÙ„Ø§ Ø­ÙÙ€ÙˆÙ’Ù„Ù ÙˆÙÙ„Ø§ Ù‚Ù€ÙˆÙÙ‘Ø©Ù Ø¥ÙÙ„Ø§Ù‘ Ø¨ÙØ§Ù„Ù„Ù‡ÙØŒ Ù„Ø§ Ø¥Ù„Ù‡Ù Ø¥Ù„Ø§Ù‘ Ø§Ù„Ù„Ù‘Ù€Ù‡ØŒ ÙˆÙÙ„Ø§ Ù†ÙØ¹Ù’Ù€Ø¨ÙÙ€Ø¯Ù Ø¥ÙÙ„Ø§Ù‘ Ø¥ÙŠÙ‘Ù€Ø§Ù‡ØŒ Ù„ÙÙ‡Ù Ø§Ù„Ù†ÙÙ‘Ø¹Ù’Ù€Ù…ÙØ©Ù ÙˆÙÙ„ÙÙ‡Ù Ø§Ù„ÙÙØ¶Ù’Ù„ ÙˆÙÙ„ÙÙ‡Ù Ø§Ù„Ø«ÙÙ‘Ù€Ù†Ø§Ø¡Ù Ø§Ù„Ø­ÙÙ€Ø³ÙÙ†ØŒ Ù„Ø§ Ø¥Ù„Ù‡Ù Ø¥Ù„Ø§Ù‘ Ø§Ù„Ù„Ù‘Ù‡Ù Ù…Ø®Ù’Ù„ÙØµÙ€ÙŠÙ†Ù Ù„_Ù€Ù‡Ù Ø§Ù„Ø¯ÙÙ‘ÙŠÙ†Ù ÙˆÙÙ„ÙÙˆÙ’ ÙƒÙÙ€Ø±ÙÙ‡Ù Ø§Ù„ÙƒÙ€Ø§ÙÙØ±ÙˆÙ†.",
            "Ù„Ø§ Ø¥Ù„Ù‡Ù Ø¥Ù„Ø§Ù‘ Ø§Ù„Ù„Ù‘Ù‡Ù ÙˆØ­Ù’Ù€Ø¯ÙÙ‡Ù Ù„Ø§ Ø´Ø±ÙŠÙƒÙ Ù„Ù‡ÙØŒ Ù„Ù‡Ù Ø§Ù„Ù…ÙÙ„ÙƒÙ ÙˆÙ„Ù‡Ù Ø§Ù„Ø­ÙÙ…Ù’Ø¯ØŒ ÙŠÙØ­ÙŠÙ€ÙŠ ÙˆÙÙŠÙÙ…Ù€ÙŠØªÙ ÙˆÙ‡ÙÙˆÙ Ø¹Ù„Ù‰ ÙƒÙÙ„Ù‘ Ø´ÙŠØ¡Ù Ù‚Ø¯ÙŠØ±.",
            "Ø§Ù„Ù„Ù‘Ù‡ÙÙ€Ù…ÙÙ‘ Ø¥ÙÙ†ÙÙ‘Ù€ÙŠ Ø£ÙØ³Ù’Ø£ÙÙ„ÙÙ€ÙƒÙ Ø¹ÙÙ„Ù’Ù…Ù€Ø§Ù‹ Ù†Ø§ÙÙØ¹Ù€Ø§Ù‹ ÙˆÙØ±ÙØ²Ù’Ù‚Ù€Ø§Ù‹ Ø·ÙÙŠÙÙ‘Ù€Ø¨Ø§Ù‹ ØŒ ÙˆÙØ¹ÙÙ…ÙÙ€Ù„Ø§Ù‹ Ù…ÙØªÙÙ‚ÙÙ€Ø¨ÙÙ‘Ù„Ø§Ù‹.",
            "Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø£ÙØ¬ÙØ±Ù’Ù†ÙÙŠ Ù…ÙÙ†Ù’ Ø§Ù„Ù†ÙÙ‘Ø§Ø±.\n\n(Ø¨Ø¹Ø¯ ØµÙ„Ø§Ø© Ø§Ù„ØµØ¨Ø­ ÙˆØ§Ù„Ù…ØºØ±Ø¨)",
            "Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø£ÙØ¹ÙÙ†ÙÙ‘ÙŠ Ø¹ÙÙ„ÙÙ‰ Ø°ÙÙƒÙ’Ø±ÙÙƒÙ ÙˆÙØ´ÙÙƒÙ’Ø±ÙÙƒÙ ÙˆÙØ­ÙØ³Ù’Ù†Ù Ø¹ÙØ¨ÙØ§Ø¯ÙØªÙÙƒÙ.\n\n(Ø«Ù„Ø§Ø« Ù…Ø±Ø§Øª Ø¨Ø¹Ø¯ ØµÙ„Ø§ØªÙŠ Ø§Ù„ÙØ¬Ø± ÙˆØ§Ù„Ù…ØºØ±Ø¨)",
            "Ø£ÙØ¹ÙÙˆØ°Ù Ø¨ÙØ§Ù„Ù„Ù‡Ù Ù…ÙÙ†Ù’ Ø§Ù„Ø´ÙÙ‘ÙŠÙ’Ø·ÙØ§Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø¬ÙÙŠÙ…Ù\n\nØ§Ù„Ù„Ù‘Ù‡Ù Ù„Ø§Ù Ø¥ÙÙ„ÙÙ€Ù‡Ù Ø¥ÙÙ„Ø§ÙÙ‘ Ù‡ÙÙˆÙ Ø§Ù„Ù’Ø­ÙÙŠÙÙ‘ Ø§Ù„Ù’Ù‚ÙÙŠÙÙ‘ÙˆÙ…Ù Ù„Ø§Ù ØªÙØ£Ù’Ø®ÙØ°ÙÙ‡Ù Ø³ÙÙ†ÙØ©ÙŒ ÙˆÙÙ„Ø§Ù Ù†ÙÙˆÙ’Ù…ÙŒ Ù„ÙÙ‘Ù‡Ù Ù…ÙØ§ ÙÙÙŠ Ø§Ù„Ø³ÙÙ‘Ù…ÙØ§ÙˆÙØ§ØªÙ ÙˆÙÙ…ÙØ§ ÙÙÙŠ Ø§Ù„Ø£ÙØ±Ù’Ø¶Ù Ù…ÙÙ† Ø°ÙØ§ Ø§Ù„ÙÙ‘Ø°ÙÙŠ ÙŠÙØ´Ù’ÙÙØ¹Ù Ø¹ÙÙ†Ù’Ø¯ÙÙ‡Ù Ø¥ÙÙ„Ø§ÙÙ‘ Ø¨ÙØ¥ÙØ°Ù’Ù†ÙÙ‡Ù ÙŠÙØ¹Ù’Ù„ÙÙ…Ù Ù…ÙØ§ Ø¨ÙÙŠÙ’Ù†Ù Ø£ÙÙŠÙ’Ø¯ÙÙŠÙ‡ÙÙ…Ù’ ÙˆÙÙ…ÙØ§ Ø®ÙÙ„Ù’ÙÙÙ‡ÙÙ…Ù’ ÙˆÙÙ„Ø§Ù ÙŠÙØ­ÙÙŠØ·ÙÙˆÙ†Ù Ø¨ÙØ´ÙÙŠÙ’Ø¡Ù Ù…ÙÙ‘Ù†Ù’ Ø¹ÙÙ„Ù’Ù…ÙÙ‡Ù Ø¥ÙÙ„Ø§ÙÙ‘ Ø¨ÙÙ…ÙØ§ Ø´ÙØ§Ø¡ ÙˆÙØ³ÙØ¹Ù ÙƒÙØ±Ù’Ø³ÙÙŠÙÙ‘Ù‡Ù Ø§Ù„Ø³ÙÙ‘Ù…ÙØ§ÙˆÙØ§ØªÙ ÙˆÙØ§Ù„Ø£ÙØ±Ù’Ø¶Ù ÙˆÙÙ„Ø§Ù ÙŠÙØ¤ÙÙˆØ¯ÙÙ‡Ù Ø­ÙÙÙ’Ø¸ÙÙ‡ÙÙ…ÙØ§ ÙˆÙÙ‡ÙÙˆÙ Ø§Ù„Ù’Ø¹ÙÙ„ÙÙŠÙÙ‘ Ø§Ù„Ù’Ø¹ÙØ¸ÙÙŠÙ…Ù.\n\n[Ø¢ÙŠØ© Ø§Ù„ÙƒØ±Ø³Ù‰ - Ø§Ù„Ø¨Ù‚Ø±Ø© 255]",
            "Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…\n\nÙ‚ÙÙ„Ù’ Ù‡ÙÙˆÙ Ù±Ù„Ù„ÙÙ‘Ù‡Ù Ø£ÙØ­ÙØ¯ÙŒØŒ Ù±Ù„Ù„ÙÙ‘Ù‡Ù Ù±Ù„ØµÙÙ‘Ù…ÙØ¯ÙØŒ Ù„ÙÙ…Ù’ ÙŠÙÙ„ÙØ¯Ù’ ÙˆÙÙ„ÙÙ…Ù’ ÙŠÙÙˆÙ„ÙØ¯Ù’ØŒ ÙˆÙÙ„ÙÙ…Ù’ ÙŠÙÙƒÙÙ† Ù„ÙÙ‘Ù‡ÙÛ¥ ÙƒÙÙÙÙˆÙ‹Ø§ Ø£ÙØ­ÙØ¯ÙŒÛ¢.\n\n[Ø³ÙˆØ±Ø© Ø§Ù„Ø¥Ø®Ù„Ø§Øµ]",
            "Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…\n\nÙ‚ÙÙ„Ù’ Ø£ÙØ¹ÙÙˆØ°Ù Ø¨ÙØ±ÙØ¨ÙÙ‘ Ù±Ù„Ù’ÙÙÙ„ÙÙ‚ÙØŒ Ù…ÙÙ† Ø´ÙØ±ÙÙ‘ Ù…ÙØ§ Ø®ÙÙ„ÙÙ‚ÙØŒ ÙˆÙÙ…ÙÙ† Ø´ÙØ±ÙÙ‘ ØºÙØ§Ø³ÙÙ‚Ù Ø¥ÙØ°ÙØ§ ÙˆÙÙ‚ÙØ¨ÙØŒ ÙˆÙÙ…ÙÙ† Ø´ÙØ±ÙÙ‘ Ù±Ù„Ù†ÙÙ‘ÙÙÙ‘Ù°Ø«ÙÙ°ØªÙ ÙÙÙ‰ Ù±Ù„Ù’Ø¹ÙÙ‚ÙØ¯ÙØŒ ÙˆÙÙ…ÙÙ† Ø´ÙØ±ÙÙ‘ Ø­ÙØ§Ø³ÙØ¯Ù Ø¥ÙØ°ÙØ§ Ø­ÙØ³ÙØ¯Ù.\n\n[Ø³ÙˆØ±Ø© Ø§Ù„ÙÙ„Ù‚]",
            "Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…\n\nÙ‚ÙÙ„Ù’ Ø£ÙØ¹ÙÙˆØ°Ù Ø¨ÙØ±ÙØ¨ÙÙ‘ Ù±Ù„Ù†ÙÙ‘Ø§Ø³ÙØŒ Ù…ÙÙ„ÙÙƒÙ Ù±Ù„Ù†ÙÙ‘Ø§Ø³ÙØŒ Ø¥ÙÙ„ÙÙ°Ù‡Ù Ù±Ù„Ù†ÙÙ‘Ø§Ø³ÙØŒ Ù…ÙÙ† Ø´ÙØ±ÙÙ‘ Ù±Ù„Ù’ÙˆÙØ³Ù’ÙˆÙØ§Ø³Ù Ù±Ù„Ù’Ø®ÙÙ†ÙÙ‘Ø§Ø³ÙØŒ Ù±Ù„ÙÙ‘Ø°ÙÙ‰ ÙŠÙÙˆÙØ³Ù’ÙˆÙØ³Ù ÙÙÙ‰ ØµÙØ¯ÙÙˆØ±Ù Ù±Ù„Ù†ÙÙ‘Ø§Ø³ÙØŒ Ù…ÙÙ†Ù Ù±Ù„Ù’Ø¬ÙÙ†ÙÙ‘Ø©Ù ÙˆÙÙ±Ù„Ù†ÙÙ‘Ø§Ø³Ù.\n\n[Ø³ÙˆØ±Ø© Ø§Ù„Ù†Ø§Ø³]\n\n(Ø«Ù„Ø§Ø« Ù…Ø±Ø§Øª Ø¨Ø¹Ø¯ ØµÙ„Ø§ØªÙŠ Ø§Ù„ÙØ¬Ø± ÙˆØ§Ù„Ù…ØºØ±Ø¨)"
        ];

        const countries = [
            'Ø§Ù„Ø£Ø±Ø¯Ù†', 'Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©', 'Ù…ØµØ±', 'Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù…ØªØ­Ø¯Ø©', 'Ù‚Ø·Ø±', 'Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†',
            'Ø§Ù„ÙƒÙˆÙŠØª', 'Ø¹Ù…Ø§Ù†', 'Ø§Ù„Ø¹Ø±Ø§Ù‚', 'Ø³ÙˆØ±ÙŠØ§', 'Ù„Ø¨Ù†Ø§Ù†', 'ÙÙ„Ø³Ø·ÙŠÙ†', 'Ø§Ù„ÙŠÙ…Ù†', 'Ù„ÙŠØ¨ÙŠØ§',
            'ØªÙˆÙ†Ø³', 'Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±', 'Ø§Ù„Ù…ØºØ±Ø¨', 'Ø§Ù„Ø³ÙˆØ¯Ø§Ù†', 'ØªØ±ÙƒÙŠØ§', 'Ø¨Ø§ÙƒØ³ØªØ§Ù†', 'Ø¥Ù†Ø¯ÙˆÙ†ÙŠØ³ÙŠØ§', 'Ù…Ø§Ù„ÙŠØ²ÙŠØ§'
        ];

        const citiesByCountry = {
            'Ø§Ù„Ø£Ø±Ø¯Ù†': ['Ø¹Ù…Ø§Ù†', 'Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡', 'Ø¥Ø±Ø¨Ø¯', 'Ø§Ù„Ø¹Ù‚Ø¨Ø©', 'Ø§Ù„Ø³Ù„Ø·', 'Ù…Ø£Ø¯Ø¨Ø§'],
            'Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©': ['Ø§Ù„Ø±ÙŠØ§Ø¶', 'Ø¬Ø¯Ø©', 'Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©', 'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©', 'Ø§Ù„Ø¯Ù…Ø§Ù…', 'Ø§Ù„Ø®Ø¨Ø±'],
            'Ù…ØµØ±': ['Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©', 'Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©', 'Ø§Ù„Ø¬ÙŠØ²Ø©', 'Ø´Ø¨Ø±Ø§ Ø§Ù„Ø®ÙŠÙ…Ø©', 'Ø¨ÙˆØ± Ø³Ø¹ÙŠØ¯', 'Ø§Ù„Ø³ÙˆÙŠØ³'],
            'Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù…ØªØ­Ø¯Ø©': ['Ø¯Ø¨ÙŠ', 'Ø£Ø¨Ùˆ Ø¸Ø¨ÙŠ', 'Ø§Ù„Ø´Ø§Ø±Ù‚Ø©', 'Ø§Ù„Ø¹ÙŠÙ†', 'Ø¹Ø¬Ù…Ø§Ù†'],
            'Ù‚Ø·Ø±': ['Ø§Ù„Ø¯ÙˆØ­Ø©', 'Ø§Ù„ÙˆÙƒØ±Ø©', 'Ø§Ù„Ø±ÙŠØ§Ù†'],
            'Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†': ['Ø§Ù„Ù…Ù†Ø§Ù…Ø©', 'Ø§Ù„Ø±ÙØ§Ø¹', 'Ø§Ù„Ù…Ø­Ø±Ù‚'],
            'Ø§Ù„ÙƒÙˆÙŠØª': ['Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙƒÙˆÙŠØª', 'Ø­ÙˆÙ„ÙŠ', 'Ø§Ù„Ø³Ø§Ù„Ù…ÙŠØ©'],
            'Ø¹Ù…Ø§Ù†': ['Ù…Ø³Ù‚Ø·', 'ØµÙ„Ø§Ù„Ø©', 'ØµØ­Ø§Ø±'],
            'Ø§Ù„Ø¹Ø±Ø§Ù‚': ['Ø¨ØºØ¯Ø§Ø¯', 'Ø§Ù„Ù…ÙˆØµÙ„', 'Ø§Ù„Ø¨ØµØ±Ø©', 'Ø£Ø±Ø¨ÙŠÙ„'],
            'Ø³ÙˆØ±ÙŠØ§': ['Ø¯Ù…Ø´Ù‚', 'Ø­Ù„Ø¨', 'Ø­Ù…Øµ'],
            'Ù„Ø¨Ù†Ø§Ù†': ['Ø¨ÙŠØ±ÙˆØª', 'Ø·Ø±Ø§Ø¨Ù„Ø³', 'ØµÙŠØ¯Ø§'],
            'ÙÙ„Ø³Ø·ÙŠÙ†': ['Ø§Ù„Ù‚Ø¯Ø³', 'ØºØ²Ø©', 'Ø±Ø§Ù… Ø§Ù„Ù„Ù‡', 'Ø§Ù„Ø®Ù„ÙŠÙ„', 'Ù†Ø§Ø¨Ù„Ø³'],
            'Ø§Ù„ÙŠÙ…Ù†': ['ØµÙ†Ø¹Ø§Ø¡', 'Ø¹Ø¯Ù†', 'ØªØ¹Ø²'],
            'Ù„ÙŠØ¨ÙŠØ§': ['Ø·Ø±Ø§Ø¨Ù„Ø³', 'Ø¨Ù†ØºØ§Ø²ÙŠ', 'Ù…ØµØ±Ø§ØªØ©'],
            'ØªÙˆÙ†Ø³': ['ØªÙˆÙ†Ø³', 'ØµÙØ§Ù‚Ø³', 'Ø³ÙˆØ³Ø©'],
            'Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±': ['Ø§Ù„Ø¬Ø²Ø§Ø¦Ø± Ø§Ù„Ø¹Ø§ØµÙ…Ø©', 'ÙˆÙ‡Ø±Ø§Ù†', 'Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©'],
            'Ø§Ù„Ù…ØºØ±Ø¨': ['Ø§Ù„Ø±Ø¨Ø§Ø·', 'Ø§Ù„Ø¯Ø§Ø± Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡', 'ÙØ§Ø³', 'Ù…Ø±Ø§ÙƒØ´'],
            'Ø§Ù„Ø³ÙˆØ¯Ø§Ù†': ['Ø§Ù„Ø®Ø±Ø·ÙˆÙ…', 'Ø£Ù… Ø¯Ø±Ù…Ø§Ù†'],
            'ØªØ±ÙƒÙŠØ§': ['Ø§Ø³Ø·Ù†Ø¨ÙˆÙ„', 'Ø£Ù†Ù‚Ø±Ø©', 'Ø¥Ø²Ù…ÙŠØ±', 'Ø¨ÙˆØ±ØµØ©', 'Ù‚ÙˆÙ†ÙŠØ©'],
            'Ø¨Ø§ÙƒØ³ØªØ§Ù†': ['ÙƒØ±Ø§ØªØ´ÙŠ', 'Ù„Ø§Ù‡ÙˆØ±', 'Ø¥Ø³Ù„Ø§Ù… Ø¢Ø¨Ø§Ø¯', 'ÙÙŠØµÙ„ Ø¢Ø¨Ø§Ø¯'],
            'Ø¥Ù†Ø¯ÙˆÙ†ÙŠØ³ÙŠØ§': ['Ø¬Ø§ÙƒØ±ØªØ§', 'Ø³ÙˆØ±Ø§Ø¨Ø§ÙŠØ§', 'Ø¨Ø§Ù†Ø¯ÙˆÙ†Øº'],
            'Ù…Ø§Ù„ÙŠØ²ÙŠØ§': ['ÙƒÙˆØ§Ù„Ø§Ù„Ù…Ø¨ÙˆØ±', 'Ø¬ÙˆØ±Ø¬ ØªØ§ÙˆÙ†', 'Ø¬ÙˆÙ‡ÙˆØ± Ø¨Ø§Ù‡Ø±Ùˆ']
        };

        function resolveLocationMapping(countryAr, cityAr) {
            const normalize = (s) => (s || '').trim();
            const c = normalize(countryAr);
            const city = normalize(cityAr);

            if (c === 'Ø§Ù„Ø£Ø±Ø¯Ù†') {
                const cityMap = {
                    'Ø¹Ù…Ø§Ù†': { apiCity: 'Amman', timeZone: 'Asia/Amman' },
                    'Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡': { apiCity: 'Zarqa', timeZone: 'Asia/Amman' },
                    'Ø¥Ø±Ø¨Ø¯': { apiCity: 'Irbid', timeZone: 'Asia/Amman' },
                    'Ø§Ù„Ø¹Ù‚Ø¨Ø©': { apiCity: 'Aqaba', timeZone: 'Asia/Amman' },
                    'Ø§Ù„Ø³Ù„Ø·': { apiCity: 'As Salt', timeZone: 'Asia/Amman' },
                    'Ù…Ø£Ø¯Ø¨Ø§': { apiCity: 'Madaba', timeZone: 'Asia/Amman' },
                };
                const m = cityMap[city];
                return {
                    apiCountry: 'Jordan',
                    apiCity: m?.apiCity ?? 'Amman',
                    method: 23,
                    timeZone: m?.timeZone ?? 'Asia/Amman',
                };
            }

            if (c === 'Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©') {
                const cityMap = {
                    'Ø§Ù„Ø±ÙŠØ§Ø¶': { apiCity: 'Riyadh', timeZone: 'Asia/Riyadh' },
                    'Ø¬Ø¯Ø©': { apiCity: 'Jeddah', timeZone: 'Asia/Riyadh' },
                    'Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©': { apiCity: 'Makkah', timeZone: 'Asia/Riyadh' },
                    'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©': { apiCity: 'Madinah', timeZone: 'Asia/Riyadh' },
                    'Ø§Ù„Ø¯Ù…Ø§Ù…': { apiCity: 'Dammam', timeZone: 'Asia/Riyadh' },
                    'Ø§Ù„Ø®Ø¨Ø±': { apiCity: 'Khobar', timeZone: 'Asia/Riyadh' },
                };
                const m = cityMap[city];
                return {
                    apiCountry: 'Saudi Arabia',
                    apiCity: m?.apiCity ?? 'Riyadh',
                    method: 4,
                    timeZone: m?.timeZone ?? 'Asia/Riyadh',
                };
            }

            if (c === 'Ù…ØµØ±') {
                const cityMap = {
                    'Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©': { apiCity: 'Cairo', timeZone: 'Africa/Cairo' },
                    'Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©': { apiCity: 'Alexandria', timeZone: 'Africa/Cairo' },
                    'Ø§Ù„Ø¬ÙŠØ²Ø©': { apiCity: 'Giza', timeZone: 'Africa/Cairo' },
                };
                const m = cityMap[city];
                return {
                    apiCountry: 'Egypt',
                    apiCity: m?.apiCity ?? 'Cairo',
                    method: 5,
                    timeZone: m?.timeZone ?? 'Africa/Cairo',
                };
            }

            return { apiCountry: countryAr, apiCity: cityAr, timeZone: 'Asia/Amman' };
        }

        // ==================== API FUNCTIONS ====================
        async function fetchPrayerTimes(country, city) {
            const mapping = resolveLocationMapping(country, city);
            const method = mapping.method ?? 23; // Ø§Ù„Ø£Ø±Ø¯Ù† Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§
            const tz = mapping.timeZone;
            const countryParam = mapping.apiCountry ?? country;
            const cityParam = mapping.apiCity ?? city;

            const params = new URLSearchParams({
                city: cityParam,
                country: countryParam,
                method: String(method),
            });
            if (tz) params.append('timezonestring', tz);

            const url = `https://api.aladhan.com/v1/timingsByCity?${params.toString()}`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Failed to fetch prayer times. Status: ${response.status}`);
                }
                const data = await response.json();

                if (data.code !== 200 || !data.data?.timings) {
                    throw new Error('Invalid data structure received from prayer times API.');
                }

                const normalize = (v) => (v ? String(v).split(' ')[0] : '');
                const t = data.data.timings;

                return {
                    fajr: normalize(t.Fajr),
                    shuruq: normalize(t.Sunrise),
                    dhuhr: normalize(t.Dhuhr),
                    asr: normalize(t.Asr),
                    maghrib: normalize(t.Maghrib),
                    isha: normalize(t.Isha),
                };
            } catch (error) {
                console.error('Error fetching prayer times data:', error);
                throw error;
            }
        }

        // ==================== DEFAULT SETTINGS ====================
        const defaultSettings = {
            mosqueName: 'Ù…Ø³Ø¬Ø¯',
            timeFormat: '12h',
            prayerTimes: {
                fajr: '04:02',
                dhuhr: '12:42',
                asr: '16:23',
                maghrib: '19:51',
                isha: '21:22',
            },
            prayerTimeOffsets: {
                fajr: 0,
                dhuhr: 0,
                asr: 0,
                maghrib: 0,
                isha: 0,
            },
            iqamaCountdown: {
                fajr: 20,
                dhuhr: 15,
                asr: 15,
                maghrib: 10,
                isha: 15,
            },
            dimDuration: 1,
            adhanDurationMinutes: 3,
            adhanDurationSeconds: 14,
            phoneImageDurationMinutes: 2,
            phoneImageDurationSeconds: 0,
            azkarDurationMinutes: 5,
            azkarDurationSeconds: 0,
            shuruqTime: '05:33',
            shuruqOffset: -5,
            jumuahTime: '12:43',
            jumuahOffset: 0,
            country: 'Ø§Ù„Ø£Ø±Ø¯Ù†',
            city: 'Ø¹Ù…Ø§Ù†',
            showWeather: true,
            temperature: 25,
            adhanSound: '',
            fajrAdhanSound: '',
            phoneImage: '',
            adhanImage: '',
            iqamaBackgroundImage: '',
            iqamaBackgroundColor: '#1e3a8a',
            volume: 0.5,
            isMuted: false,
            azkarBackgroundImage: '',
            backgroundImage: '',
            adhanTextPosition: 'center',
            colors: {
                textColor: '#FFFFFF',
                nextPrayerTextColor: '#FFD700',
                iqamaCountdownTextColor: '#FFFFFF',
                azkarTextColor: '#FFFFFF',
                shuruqBoxColor: '#1e3a8a',
                clockBoxColor: '#1d4ed8',
                jumuahBoxColor: '#1e3a8a',
                prayerBoxesColor: '#1e3a8a',
            },
        };

        // ==================== UPDATE FUNCTIONS ====================
        async function updatePrayerTimes() {
            try {
                const settings = getSettings();
                const newTimes = await fetchPrayerTimes(settings.country, settings.city);
                
                // ØªØ­Ø¯ÙŠØ« Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
                settings.prayerTimes = newTimes;
                
                // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø§Ù„Ø´Ø±ÙˆÙ‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                if (newTimes.shuruq) {
                    settings.shuruqTime = newTimes.shuruq;
                }
                
                // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                state.settings = settings;
                saveSettings();
                
                console.log('ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© Ø¨Ù†Ø¬Ø§Ø­');
                // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                renderMainScreen();
                return true;
            } catch (error) {
                console.error('ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©:', error);
                return false;
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
        window.addEventListener('load', async () => {
            await updatePrayerTimes();
            
            // ØªØ­Ø¯ÙŠØ« ÙŠÙˆÙ…ÙŠØ§Ù‹ ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„
            function scheduleMidnightUpdate() {
                const now = new Date();
                const midnight = new Date(now);
                midnight.setHours(24, 0, 0, 0); // Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„
                
                const timeUntilMidnight = midnight - now;
                
                // Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙˆÙ„ Ù„Ù„ÙŠÙ„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
                setTimeout(updatePrayerTimes, timeUntilMidnight);
                
                // Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ©
                setInterval(updatePrayerTimes, 24 * 60 * 60 * 1000);
            }
            
            scheduleMidnightUpdate();
        });
        
        // ==================== UTILITY FUNCTIONS ====================
        function applyOffsetToTime(time, offsetMinutes) {
            if (!time || !time.includes(':')) return time;
            const [hours, minutes] = time.split(':').map(Number);
            if (isNaN(hours) || isNaN(minutes)) return time;
            
            const totalMinutes = hours * 60 + minutes + offsetMinutes;
            const adjustedMinutes = ((totalMinutes % 1440) + 1440) % 1440;
            const newHours = Math.floor(adjustedMinutes / 60);
            const newMinutes = adjustedMinutes % 60;
            
            return `${String(newHours).padStart(2, '0')}:${String(newMinutes).padStart(2, '0')}`;
        }

        function formatPrayerTime(time24, timeFormat, nowTz) {
            if (!time24 || !time24.includes(':')) return '';
            const [hours, minutes] = time24.split(':');
            if (isNaN(parseInt(hours)) || isNaN(parseInt(minutes))) return '';
            
            const date = new Date(nowTz);
            date.setHours(parseInt(hours, 10), parseInt(minutes, 10), 0, 0);
            
            if (timeFormat === '12h') {
                let h = date.getHours();
                const period = h >= 12 ? 'PM' : 'AM';
                h = h % 12 || 12;
                return `${h}:${String(date.getMinutes()).padStart(2, '0')}`;
            } else {
                return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
            }
        }

        function formatHijriDate(date) {
            return new Intl.DateTimeFormat('ar-SA-u-ca-islamic-civil', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
            }).format(date);
        }

        function formatGregorianDate(date) {
            return new Intl.DateTimeFormat('ar-EG', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
            }).format(date);
        }

        // ==================== STATE MANAGEMENT ====================
        let state = {
            settings: JSON.parse(JSON.stringify(defaultSettings)),
            isPanelOpen: false,
            isFetchingTimes: false,
            isOffline: false,
            currentPhase: 'idle', // 'idle' | 'adhan' | 'iqamaCountdown' | 'phoneImage' | 'azkar'
            activePrayer: null,
            iqamaEndTime: null,
            currentAzkarIndex: 0,
            currentTime: new Date(),
            phaseTimeoutRef: null,
            azkarIntervalRef: null,
            isAdhanPlaying: false,
            audioUnlocked: false,
        };

        // ==================== SETTINGS FUNCTIONS ====================
        function getSettings() {
            try {
                const savedSettings = localStorage.getItem('alMoazinClockSettings');
                if (savedSettings) {
                    const parsedSettings = JSON.parse(savedSettings);
                    return {
                        ...defaultSettings,
                        ...parsedSettings
                    };
                }
            } catch (e) {
                console.error('Error loading settings:', e);
            }
            return defaultSettings;
        }
        
        // ==================== INITIALIZATION ====================
        function init() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† localStorage Ù…ØªØ§Ø­
            if (typeof(Storage) === "undefined") {
                console.error('âŒ localStorage ØºÙŠØ± Ù…ØªØ§Ø­ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­');
                state.settings = JSON.parse(JSON.stringify(defaultSettings));
                renderMainScreen();
                return;
            }
            
            // Load settings from localStorage
            try {
                console.log('ğŸ“‚ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† localStorage...');
                const savedSettings = localStorage.getItem('alMoazinClockSettings');
                const savedMedia = localStorage.getItem('alMoazinMediaFiles');
                const savedPrayerTimesData = localStorage.getItem('alMoazinPrayerTimesData');
                
                console.log('ğŸ“¦ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:', {
                    hasSettings: !!savedSettings,
                    hasMedia: !!savedMedia,
                    hasPrayerTimesData: !!savedPrayerTimesData,
                    settingsLength: savedSettings ? savedSettings.length : 0,
                    mediaLength: savedMedia ? savedMedia.length : 0,
                    prayerTimesDataLength: savedPrayerTimesData ? savedPrayerTimesData.length : 0
                });
                
                if (savedSettings) {
                    console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©');
                    const parsedSettings = JSON.parse(savedSettings);
                    let parsedMedia = {};
                    let parsedPrayerTimesData = {};
                    
                    if (savedMedia) {
                        try {
                            parsedMedia = JSON.parse(savedMedia);
                            console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:', {
                                hasBackgroundImage: !!parsedMedia.backgroundImage,
                                hasPhoneImage: !!parsedMedia.phoneImage,
                                hasAdhanImage: !!parsedMedia.adhanImage,
                                hasIqamaBackgroundImage: !!parsedMedia.iqamaBackgroundImage,
                                hasAzkarBackgroundImage: !!parsedMedia.azkarBackgroundImage,
                                hasAdhanSound: !!parsedMedia.adhanSound,
                                hasFajrAdhanSound: !!parsedMedia.fajrAdhanSound
                            });
                        } catch (e) {
                            console.warn('âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:', e);
                            parsedMedia = {};
                        }
                    } else {
                        console.log('ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ù…Ø­ÙÙˆØ¸Ø©');
                    }

                    if (savedPrayerTimesData) {
                        try {
                            parsedPrayerTimesData = JSON.parse(savedPrayerTimesData);
                            console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:', {
                                lastUpdated: parsedPrayerTimesData.lastUpdated,
                                hasPrayerTimes: !!parsedPrayerTimesData.prayerTimes,
                                hasPrayerTimeOffsets: !!parsedPrayerTimesData.prayerTimeOffsets
                            });
                        } catch (e) {
                            console.warn('âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©:', e);
                            parsedPrayerTimesData = {};
                        }
                    } else {
                        console.log('ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ§Ù‚ÙŠØª ØµÙ„Ø§Ø© Ù…Ø­ÙÙˆØ¸Ø©');
                    }
                    
                    // Ø¯Ù…Ø¬ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙŠÙ…
                    // Ø§Ù„Ù…Ù„ÙØ§Øª ÙŠØ¬Ø¨ Ø£Ù† ØªØ£ØªÙŠ Ø¨Ø¹Ø¯ parsedSettings Ù„ØªØªØ¬Ø§ÙˆØ² Ø£ÙŠ Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                    state.settings = {
                        ...defaultSettings,
                        ...parsedSettings,
                        // Ø¯Ù…Ø¬ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„ÙŠÙ‡Ø§
                        backgroundImage: parsedMedia.backgroundImage || parsedSettings.backgroundImage || defaultSettings.backgroundImage,
                        phoneImage: parsedMedia.phoneImage || parsedSettings.phoneImage || defaultSettings.phoneImage,
                        adhanImage: parsedMedia.adhanImage || parsedSettings.adhanImage || defaultSettings.adhanImage,
                        iqamaBackgroundImage: parsedMedia.iqamaBackgroundImage || parsedSettings.iqamaBackgroundImage || defaultSettings.iqamaBackgroundImage,
                        azkarBackgroundImage: parsedMedia.azkarBackgroundImage || parsedSettings.azkarBackgroundImage || defaultSettings.azkarBackgroundImage,
                        adhanSound: parsedMedia.adhanSound || parsedSettings.adhanSound || defaultSettings.adhanSound,
                        fajrAdhanSound: parsedMedia.fajrAdhanSound || parsedSettings.fajrAdhanSound || defaultSettings.fajrAdhanSound,
                        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¯Ù…Ø¬ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
                        colors: {
                            ...defaultSettings.colors,
                            ...(parsedSettings.colors || {}),
                        },
                        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¯Ù…Ø¬ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
                        prayerTimes: {
                            ...defaultSettings.prayerTimes,
                            ...(parsedSettings.prayerTimes || {}),
                        },
                        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¯Ù…Ø¬ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
                        iqamaCountdown: {
                            ...defaultSettings.iqamaCountdown,
                            ...(parsedSettings.iqamaCountdown || {}),
                        },
                        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¯Ù…Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„ÙŠØ¯ÙˆÙŠØ© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
                        prayerTimeOffsets: {
                            ...defaultSettings.prayerTimeOffsets,
                            ...(parsedSettings.prayerTimeOffsets || {}),
                        },
                    };
                    
                    // Ø¥Ø²Ø§Ù„Ø© lastSaved Ù…Ù† state.settings Ù„Ø£Ù†Ù‡ Ù„ÙŠØ³ Ø¬Ø²Ø¡Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                    if (state.settings.lastSaved) {
                        delete state.settings.lastSaved;
                    }
                    console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­:', {
                        mosqueName: state.settings.mosqueName,
                        country: state.settings.country,
                        city: state.settings.city,
                        prayerTimes: state.settings.prayerTimes,
                        iqamaCountdown: state.settings.iqamaCountdown,
                        colors: state.settings.colors,
                        lastSaved: parsedSettings.lastSaved
                    });
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
                    if (!state.settings.prayerTimes || !state.settings.colors || !state.settings.iqamaCountdown) {
                        console.warn('âš ï¸ Ø¨Ø¹Ø¶ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ÙÙ‚ÙˆØ¯Ø© - Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©');
                        state.settings = {
                            ...defaultSettings,
                            ...state.settings,
                            prayerTimes: state.settings.prayerTimes || defaultSettings.prayerTimes,
                            colors: state.settings.colors || defaultSettings.colors,
                            iqamaCountdown: state.settings.iqamaCountdown || defaultSettings.iqamaCountdown,
                        };
                    }
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ø£Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
                    console.log('ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:', {
                        hasPrayerTimes: !!state.settings.prayerTimes,
                        hasColors: !!state.settings.colors,
                        hasIqamaCountdown: !!state.settings.iqamaCountdown,
                        mosqueName: state.settings.mosqueName,
                        prayerTimesCount: Object.keys(state.settings.prayerTimes || {}).length,
                        hasBackgroundImage: !!state.settings.backgroundImage,
                        backgroundImageLength: state.settings.backgroundImage ? state.settings.backgroundImage.length : 0,
                        hasPhoneImage: !!state.settings.phoneImage,
                        hasAdhanImage: !!state.settings.adhanImage
                    });
                } else {
                    console.log('ğŸ†• Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© - Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©');
                    state.settings = JSON.parse(JSON.stringify(defaultSettings));
                    
                    // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
                    try {
                        const essentialSettings = {
                            ...defaultSettings,
                            lastSaved: new Date().toISOString()
                        };
                        delete essentialSettings.backgroundImage;
                        delete essentialSettings.iqamaBackgroundImage;
                        delete essentialSettings.azkarBackgroundImage;
                        delete essentialSettings.phoneImage;
                        delete essentialSettings.adhanImage;
                        delete essentialSettings.adhanSound;
                        delete essentialSettings.fajrAdhanSound;
                        localStorage.setItem('alMoazinClockSettings', JSON.stringify(essentialSettings));
                        console.log('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©');
                    } catch (e) {
                        console.warn('âš ï¸ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©:', e);
                    }
                }
            } catch (error) {
                console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:', error);
                state.settings = JSON.parse(JSON.stringify(defaultSettings));
            }

            // Initialize audio
            const audioRef = document.getElementById('audioRef');
            if (audioRef) {
                audioRef.volume = state.settings.volume;
                audioRef.muted = state.settings.isMuted;
            }

            // Start clock
            setInterval(() => {
                state.currentTime = new Date();
                updateUI();
            }, 1000);

            // Initial render
            renderMainScreen();
            setupEventListeners();
            checkPrayerTime();
            
            // Check prayer time every 250ms - ÙØ­Øµ Ù…ØªÙƒØ±Ø± Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ØªÙÙˆÙŠØª ÙˆÙ‚Øª Ø§Ù„ØµÙ„Ø§Ø©
            setInterval(checkPrayerTime, 250);
            
            // ÙØ­Øµ Ø¥Ø¶Ø§ÙÙŠ ÙƒÙ„ Ø«Ø§Ù†ÙŠØ© Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ØªÙÙˆÙŠØª ÙˆÙ‚Øª Ø§Ù„ØµÙ„Ø§Ø©
            setInterval(() => {
                if (state.currentPhase === 'idle') {
                    checkPrayerTime();
                }
            }, 1000);
            
            // Check iqama countdown
            setInterval(checkIqamaCountdown, 1000);
            
            // Initialize prayer times update system
            initializePrayerTimesUpdates();
        }
        
        // ==================== PRAYER TIMES AUTO-UPDATE SYSTEM ====================
        function initializePrayerTimesUpdates() {
            console.log('[AUTO UPDATE] ğŸš€ Ø¨Ø¯Ø¡ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…ÙˆØ§Ù‚ÙŠØª');
            
            // 1. ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            const initializeApp = async () => {
                console.log('[INIT] ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ - ÙØ­Øµ Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ù„ØªØ­Ø¯ÙŠØ«');
                
                const storedTimesData = localStorage.getItem('alMoazinPrayerTimes');
                let needsUpdate = true;
                
                if (storedTimesData) {
                    try {
                        const { date, fetchTime } = JSON.parse(storedTimesData);
                        const today = `${state.currentTime.getFullYear()}-${String(state.currentTime.getMonth() + 1).padStart(2, '0')}-${String(state.currentTime.getDate()).padStart(2, '0')}`;
                        const isToday = date === today;
                        const fetchAge = Date.now() - (fetchTime || 0);
                        const maxAge = 12 * 60 * 60 * 1000; // 12 Ø³Ø§Ø¹Ø©
                        
                        if (isToday && fetchAge < maxAge) {
                            needsUpdate = false;
                            console.log('[INIT] âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ø¯Ø«Ø© - Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†');
                        } else {
                            console.log(`[INIT] âš ï¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ÙŠÙ…Ø© - Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù…Ø·Ù„ÙˆØ¨ (Ø§Ù„Ø¹Ù…Ø±: ${Math.round(fetchAge / 60000)} Ø¯Ù‚ÙŠÙ‚Ø©)`);
                        }
                    } catch (e) {
                        console.log('[INIT] âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© - Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«');
                    }
                } else {
                    console.log('[INIT] ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© - Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«');
                }
                
                if (needsUpdate) {
                    await fetchPrayerTimesAndWeather(true);
                }
            };
            
            initializeApp();
            
            // 2. ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª
            const REFRESH_INTERVAL = 6 * 60 * 60 * 1000; // 6 Ø³Ø§Ø¹Ø§Øª
            const periodicUpdateId = setInterval(async () => {
                console.log(`[PERIODIC UPDATE] ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ Ù„Ù„Ù…ÙˆØ§Ù‚ÙŠØª`);
                try {
                    await fetchPrayerTimesAndWeather(true);
                } catch (error) {
                    console.log('[PERIODIC UPDATE] âš ï¸ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª');
                }
            }, REFRESH_INTERVAL);
            
            // 3. ÙØ­Øµ ÙŠÙˆÙ…ÙŠ Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙƒÙ„ Ø³Ø§Ø¹Ø©
            const DAILY_CHECK_INTERVAL = 60 * 60 * 1000; // Ø³Ø§Ø¹Ø© ÙˆØ§Ø­Ø¯Ø©
            const dailyCheckId = setInterval(async () => {
                const storedTimesData = localStorage.getItem('alMoazinPrayerTimes');
                if (storedTimesData) {
                    try {
                        const { date } = JSON.parse(storedTimesData);
                        const today = `${state.currentTime.getFullYear()}-${String(state.currentTime.getMonth() + 1).padStart(2, '0')}-${String(state.currentTime.getDate()).padStart(2, '0')}`;
                        
                        if (date !== today) {
                            console.log(`[DAILY CHECK] ğŸ“… Ø§ÙƒØªØ´Ø§Ù ØªØ§Ø±ÙŠØ® Ø¬Ø¯ÙŠØ¯ ${today} - Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«`);
                            try {
                                await fetchPrayerTimesAndWeather(true);
                                console.log('[DAILY CHECK] âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª');
                            } catch (error) {
                                console.log('[DAILY CHECK] âš ï¸ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª');
                            }
                        }
                    } catch (e) {
                        console.error('[DAILY CHECK] âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„ØªØ§Ø±ÙŠØ®:', e);
                    }
                }
            }, DAILY_CHECK_INTERVAL);
            
            // 4. ØªØ­Ø¯ÙŠØ« ÙŠÙˆÙ…ÙŠ Ù…Ø¶Ù…ÙˆÙ† Ø¹Ù†Ø¯ Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„
            const scheduleMidnightUpdate = () => {
                const now = new Date();
                const midnight = new Date(now);
                midnight.setHours(0, 0, 0, 0);
                midnight.setDate(midnight.getDate() + 1); // Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¯Ù…
                
                const msUntilMidnight = midnight.getTime() - now.getTime();
                
                console.log(`[MIDNIGHT UPDATE] ğŸŒ™ Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø¹Ù†Ø¯ Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„ Ø¨Ø¹Ø¯ ${Math.round(msUntilMidnight / (1000 * 60 * 60))} Ø³Ø§Ø¹Ø©`);
                
                return setTimeout(async () => {
                    console.log('[MIDNIGHT UPDATE] ğŸŒ… Ø­Ø§Ù† Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„ - Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙŠÙˆÙ…ÙŠ');
                    
                    try {
                        await fetchPrayerTimesAndWeather(true);
                        console.log('[MIDNIGHT UPDATE] âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø¨Ù†Ø¬Ø§Ø­');
                    } catch (error) {
                        console.log('[MIDNIGHT UPDATE] âš ï¸ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª');
                    }
                    
                    // Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ù„ÙŠ
                    scheduleMidnightUpdate();
                }, msUntilMidnight);
            };
            
            const midnightTimeoutId = scheduleMidnightUpdate();
            
            // 5. ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø¯ Ø§Ù„ÙØ¬Ø± (Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ù„ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ÙØ¬Ø±)
            const scheduleNextFajrUpdate = () => {
                const fajrTime = state.settings.prayerTimes.fajr;
                if (!fajrTime || !fajrTime.includes(':')) return;
                
                try {
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    
                    const [hours, minutes] = fajrTime.split(':').map(Number);
                    tomorrow.setHours(hours, minutes, 0, 0);
                    
                    const msUntilNextFajr = tomorrow.getTime() - new Date().getTime();
                    
                    if (msUntilNextFajr > 0) {
                        console.log(`[FAJR UPDATE] ğŸ•°ï¸ Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ù„ÙŠ Ø¹Ù†Ø¯ ÙØ¬Ø± Ø§Ù„ØºØ¯ (${fajrTime}) - Ø¨Ø¹Ø¯ ${Math.round(msUntilNextFajr / (1000 * 60 * 60))} Ø³Ø§Ø¹Ø©`);
                        
                        setTimeout(async () => {
                            console.log(`[FAJR UPDATE] ğŸŒ… Ù‚Ø¯ Ø­Ø§Ù† ÙØ¬Ø± ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯ - Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«`);
                            await fetchPrayerTimesAndWeather(true);
                            scheduleNextFajrUpdate(); // Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ù„ÙŠ
                        }, msUntilNextFajr);
                    }
                } catch (error) {
                    console.error(`[FAJR UPDATE] âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«:`, error);
                }
            };
            
            // Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø¯ Ø§Ù„ÙØ¬Ø± Ø¨Ø¹Ø¯ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„Ø£ÙˆÙ„Ù‰
            setTimeout(() => {
                scheduleNextFajrUpdate();
            }, 5000); // Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ Ù…Ù† Ø§Ù„ØªØ­Ù…ÙŠÙ„
            
            console.log('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆØ§Ù„ÙŠÙˆÙ…ÙŠ ÙˆØ§Ù„Ø¯ÙˆØ±ÙŠ ÙˆØ§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ');
            
            // ØªÙ†Ø¸ÙŠÙ Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ø³ÙŠØªÙ… ØªÙ†Ø¸ÙŠÙ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©)
            window.addEventListener('beforeunload', () => {
                clearInterval(periodicUpdateId);
                clearTimeout(midnightTimeoutId);
                clearInterval(dailyCheckId);
            });
        }

        // ==================== PRAYER TIME CHECKING ====================
        let lastCheckedTime = '';
        let lastTriggeredPrayer = null;
        let lastTriggeredTime = '';
        let prayerInterval = null;
        
        // Ø¯Ø§Ù„Ø© Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø°Ø§Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        function startPrayerMonitoring() {
            // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø³Ø§Ø¨Ù‚Ø©
            if (prayerInterval) {
                clearInterval(prayerInterval);
            }
            
            // ØªØ­ÙˆÙŠÙ„ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© Ø¥Ù„Ù‰ Ø¯Ù‚Ø§Ø¦Ù‚ Ù…Ù† Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„
            const timeToMinutes = (timeStr) => {
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            };
            
            const prayerTimes = state.settings.prayerTimes;
            if (!prayerTimes || Object.keys(prayerTimes).length === 0) {
                console.warn('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆÙ‚Ø§Øª ØµÙ„Ø§Ø© Ù…Ø­ÙÙˆØ¸Ø© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©');
                return;
            }
            
            const fajrMinutes = timeToMinutes(prayerTimes.fajr);
            const dhuhrMinutes = timeToMinutes(prayerTimes.dhuhr);
            const asrMinutes = timeToMinutes(prayerTimes.asr);
            const maghribMinutes = timeToMinutes(prayerTimes.maghrib);
            const ishaMinutes = timeToMinutes(prayerTimes.isha);
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ
            const checkTime = () => {
                const now = new Date();
                const currentMinutes = now.getHours() * 60 + now.getMinutes();
                const currentSeconds = now.getSeconds();
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„ ØµÙ„Ø§Ø© (Ø¯Ù‚ÙŠÙ‚Ø© Ø¨Ø¹Ø¯ Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙˆÙ‚Øª)
                if (currentMinutes >= fajrMinutes && currentMinutes < fajrMinutes + 1 && currentSeconds < 10) {
                    // Ø§Ù„Ø£Ø°Ø§Ù† Ù„ÙØ¬Ø± (Ø¯Ù‚ÙŠÙ‚Ø© Ø¨Ø¹Ø¯ Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙˆÙ‚Øª)
                    if (!lastTriggeredPrayer || lastTriggeredPrayer !== 'fajr' || lastTriggeredTime !== prayerTimes.fajr) {
                        console.log(`ğŸ•°ï¸ Ø­Ø§Ù† ÙˆÙ‚Øª ØµÙ„Ø§Ø© Ø§Ù„ÙØ¬Ø± - Ø¨Ø¯Ø¡ Ø§Ù„Ø£Ø°Ø§Ù†`);
                        
                        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„ÙØ§Øª Ø§Ù„Ø£Ø°Ø§Ù†
                        const adhanFile = state.settings.fajrAdhanSound || 'audio/audio_fajr.mp3';
                        console.log(`ğŸµ Ø³ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø£Ø°Ø§Ù†: ${adhanFile}`);
                        
                        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø°Ø§Ù† Ù…Ø¨Ø§Ø´Ø±Ø©
                        triggerAdhan('fajr');
                        lastTriggeredPrayer = 'fajr';
                        lastTriggeredTime = prayerTimes.fajr;
                    }
                } else if (currentMinutes >= dhuhrMinutes && currentMinutes < dhuhrMinutes + 1 && currentSeconds < 10) {
                    // Ø§Ù„Ø£Ø°Ø§Ù† Ù„Ø¸Ù‡Ø± (Ø¯Ù‚ÙŠÙ‚Ø© Ø¨Ø¹Ø¯ Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙˆÙ‚Øª)
                    if (!lastTriggeredPrayer || lastTriggeredPrayer !== 'dhuhr' || lastTriggeredTime !== prayerTimes.dhuhr) {
                        console.log(`ğŸ•°ï¸ Ø­Ø§Ù† ÙˆÙ‚Øª ØµÙ„Ø§Ø© Ø§Ù„Ø¸Ù‡Ø± - Ø¨Ø¯Ø¡ Ø§Ù„Ø£Ø°Ø§Ù†`);
                        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ù‚Ø¨Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø°Ø§Ù†
                        if (!state.audioUnlocked) {
                            const audioRef = document.getElementById('audioRef');
                            if (audioRef) {
                                try {
                                    audioRef.volume = 0;
                                    const playPromise = audioRef.play();
                                    if (playPromise) {
                                        playPromise.then(() => {
                                            audioRef.pause();
                                            audioRef.currentTime = 0;
                                            audioRef.volume = state.settings.volume;
                                            state.audioUnlocked = true;
                                            console.log('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª');
                                            triggerAdhan('dhuhr');
                                        }).catch((e) => {
                                            console.warn('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹:', e);
                                            triggerAdhan('dhuhr');
                                        });
                                    } else {
                                        triggerAdhan('dhuhr');
                                    }
                                } catch (e) {
                                    console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª:', e);
                                    triggerAdhan('dhuhr');
                                }
                            } else {
                                console.error('âŒ audioRef ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
                                triggerAdhan('dhuhr');
                            }
                        } else {
                            triggerAdhan('dhuhr');
                        }
                        lastTriggeredPrayer = 'dhuhr';
                        lastTriggeredTime = prayerTimes.dhuhr;
                    }
                } else if (currentMinutes >= asrMinutes && currentMinutes < asrMinutes + 1 && currentSeconds < 10) {
                    // Ø§Ù„Ø£Ø°Ø§Ù† Ù„Ø¹ØµØ± (Ø¯Ù‚ÙŠÙ‚Ø© Ø¨Ø¹Ø¯ Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙˆÙ‚Øª)
                    if (!lastTriggeredPrayer || lastTriggeredPrayer !== 'asr' || lastTriggeredTime !== prayerTimes.asr) {
                        console.log(`ğŸ•°ï¸ Ø­Ø§Ù† ÙˆÙ‚Øª ØµÙ„Ø§Ø© Ø§Ù„Ø¹ØµØ± - Ø¨Ø¯Ø¡ Ø§Ù„Ø£Ø°Ø§Ù†`);
                        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ù‚Ø¨Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø°Ø§Ù†
                        if (!state.audioUnlocked) {
                            const audioRef = document.getElementById('audioRef');
                            if (audioRef) {
                                try {
                                    audioRef.volume = 0;
                                    const playPromise = audioRef.play();
                                    if (playPromise) {
                                        playPromise.then(() => {
                                            audioRef.pause();
                                            audioRef.currentTime = 0;
                                            audioRef.volume = state.settings.volume;
                                            state.audioUnlocked = true;
                                            console.log('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª');
                                            triggerAdhan('asr');
                                        }).catch((e) => {
                                            console.warn('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹:', e);
                                            triggerAdhan('asr');
                                        });
                                    } else {
                                        triggerAdhan('asr');
                                    }
                                } catch (e) {
                                    console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª:', e);
                                    triggerAdhan('asr');
                                }
                            } else {
                                console.error('âŒ audioRef ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
                                triggerAdhan('asr');
                            }
                        } else {
                            triggerAdhan('asr');
                        }
                        lastTriggeredPrayer = 'asr';
                        lastTriggeredTime = prayerTimes.asr;
                    }
                } else if (currentMinutes >= maghribMinutes && currentMinutes < maghribMinutes + 1 && currentSeconds < 10) {
                    // Ø§Ù„Ø£Ø°Ø§Ù† Ù„Ù…ØºØ±Ø¨ (Ø¯Ù‚ÙŠÙ‚Ø© Ø¨Ø¹Ø¯ Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙˆÙ‚Øª)
                    if (!lastTriggeredPrayer || lastTriggeredPrayer !== 'maghrib' || lastTriggeredTime !== prayerTimes.maghrib) {
                        console.log(`ğŸ•°ï¸ Ø­Ø§Ù† ÙˆÙ‚Øª ØµÙ„Ø§Ø© Ø§Ù„Ù…ØºØ±Ø¨ - Ø¨Ø¯Ø¡ Ø§Ù„Ø£Ø°Ø§Ù†`);
                        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ù‚Ø¨Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø°Ø§Ù†
                        if (!state.audioUnlocked) {
                            const audioRef = document.getElementById('audioRef');
                            if (audioRef) {
                                try {
                                    audioRef.volume = 0;
                                    const playPromise = audioRef.play();
                                    if (playPromise) {
                                        playPromise.then(() => {
                                            audioRef.pause();
                                            audioRef.currentTime = 0;
                                            audioRef.volume = state.settings.volume;
                                            state.audioUnlocked = true;
                                            console.log('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª');
                                            triggerAdhan('maghrib');
                                        }).catch((e) => {
                                            console.warn('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹:', e);
                                            triggerAdhan('maghrib');
                                        });
                                    } else {
                                        triggerAdhan('maghrib');
                                    }
                                } catch (e) {
                                    console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª:', e);
                                    triggerAdhan('maghrib');
                                }
                            } else {
                                console.error('âŒ audioRef ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
                                triggerAdhan('maghrib');
                            }
                        } else {
                            triggerAdhan('maghrib');
                        }
                        lastTriggeredPrayer = 'maghrib';
                        lastTriggeredTime = prayerTimes.maghrib;
                    }
                } else if (currentMinutes >= ishaMinutes && currentMinutes < ishaMinutes + 1 && currentSeconds < 10) {
                    // Ø§Ù„Ø£Ø°Ø§Ù† Ù„Ø¹Ø´Ø§Ø¡ (Ø¯Ù‚ÙŠÙ‚Ø© Ø¨Ø¹Ø¯ Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙˆÙ‚Øª)
                    if (!lastTriggeredPrayer || lastTriggeredPrayer !== 'isha' || lastTriggeredTime !== prayerTimes.isha) {
                        console.log(`ğŸ•°ï¸ Ø­Ø§Ù† ÙˆÙ‚Øª ØµÙ„Ø§Ø© Ø§Ù„Ø¹Ø´Ø§Ø¡ - Ø¨Ø¯Ø¡ Ø§Ù„Ø£Ø°Ø§Ù†`);
                        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ù‚Ø¨Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø°Ø§Ù†
                        if (!state.audioUnlocked) {
                            const audioRef = document.getElementById('audioRef');
                            if (audioRef) {
                                try {
                                    audioRef.volume = 0;
                                    const playPromise = audioRef.play();
                                    if (playPromise) {
                                        playPromise.then(() => {
                                            audioRef.pause();
                                            audioRef.currentTime = 0;
                                            audioRef.volume = state.settings.volume;
                                            state.audioUnlocked = true;
                                            console.log('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª');
                                            triggerAdhan('isha');
                                        }).catch((e) => {
                                            console.warn('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹:', e);
                                            triggerAdhan('isha');
                                        });
                                    } else {
                                        triggerAdhan('isha');
                                    }
                                } catch (e) {
                                    console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª:', e);
                                    triggerAdhan('isha');
                                }
                            } else {
                                console.error('âŒ audioRef ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
                                triggerAdhan('isha');
                            }
                        } else {
                            triggerAdhan('isha');
                        }
                        lastTriggeredPrayer = 'isha';
                        lastTriggeredTime = prayerTimes.isha;
                    }
                }
            };
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
            prayerInterval = setInterval(checkTime, 60000);
            // Ø§Ù„ØªØ­Ù‚Ù‚ ÙÙˆØ±Ø§Ù‹
            checkTime();
            
            console.log('âœ… Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹');
        }
        
        function checkPrayerTime() {
            if (state.currentPhase !== 'idle') {
                // Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ Ù…Ø±Ø­Ù„Ø© Ø£Ø®Ø±Ù‰ØŒ Ù„Ø§ Ù†ØªØ­Ù‚Ù‚
                return;
            }
            
            const now = new Date();
            const currentHours = now.getHours();
            const currentMinutes = now.getMinutes();
            const currentSeconds = now.getSeconds();
            const currentTime = `${String(currentHours).padStart(2, '0')}:${String(currentMinutes).padStart(2, '0')}`;
            const currentTimeFull = `${currentTime}:${String(currentSeconds).padStart(2, '0')}`;
            
            // Ø·Ø¨Ø§Ø¹Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù„ØªØ­Ù‚Ù‚ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† lastTriggeredTime
            if (currentTime !== lastCheckedTime && currentSeconds === 0) {
                console.log(`ğŸ” ÙØ­Øµ ÙˆÙ‚Øª Ø§Ù„ØµÙ„Ø§Ø© - Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ: ${currentTimeFull}`);
                console.log('ğŸ“‹ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:', state.settings.prayerTimes);
                console.log('ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:', {
                    currentPhase: state.currentPhase,
                    activePrayer: state.activePrayer,
                    isAdhanPlaying: state.isAdhanPlaying,
                    lastTriggeredPrayer: lastTriggeredPrayer,
                    lastTriggeredTime: lastTriggeredTime
                });
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† lastTriggeredTime Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø°Ø§Ù† ÙÙŠ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                if (lastCheckedTime && lastCheckedTime !== currentTime) {
                    console.log(`ğŸ”„ ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ù† ${lastCheckedTime} Ø¥Ù„Ù‰ ${currentTime} - Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† lastTriggeredTime`);
                    // Ù†Ø¹ÙŠØ¯ ØªØ¹ÙŠÙŠÙ† lastTriggeredTime ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… Ù†ÙƒÙ† ÙÙŠ Ù†ÙØ³ ÙˆÙ‚Øª Ø§Ù„ØµÙ„Ø§Ø©
                    const previousPrayerTime = lastTriggeredTime.split('-')[1];
                    if (previousPrayerTime !== currentTime) {
                        lastTriggeredTime = '';
                        lastTriggeredPrayer = null;
                        console.log('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† lastTriggeredTime');
                    }
                }
                
                lastCheckedTime = currentTime;
            }
            
            const prayerTimes = state.settings.prayerTimes;
            
            if (!prayerTimes || Object.keys(prayerTimes).length === 0) {
                if (currentSeconds === 0) {
                    console.warn('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆÙ‚Ø§Øª ØµÙ„Ø§Ø© Ù…Ø­ÙÙˆØ¸Ø©');
                }
                return;
            }
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØµÙ„Ø§Ø© ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ - Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù‚Ø§Ø±Ù†Ø© Ù†ØµÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø©
            const prayerName = Object.keys(prayerTimes).find(p => {
                const prayerTime = prayerTimes[p];
                if (!prayerTime) return false;
                
                // ØªØ·Ø¨ÙŠØ¹ Ø§Ù„ÙˆÙ‚Øª Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµØ­ÙŠØ­ (HH:MM)
                const normalizedPrayerTime = prayerTime.includes(':') ? prayerTime : null;
                if (!normalizedPrayerTime) return false;
                
                // Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù†ØµÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© (HH:MM)
                const matches = normalizedPrayerTime === currentTime;
                
                // Ø·Ø¨Ø§Ø¹Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø¨ Ù…Ù† ÙˆÙ‚Øª Ø§Ù„ØµÙ„Ø§Ø©
                if (matches) {
                    console.log(`ğŸ”” âœ… âœ… âœ… ØªØ·Ø§Ø¨Ù‚! ØµÙ„Ø§Ø© ${prayerNames[p]}: Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ ${currentTimeFull} - ÙˆÙ‚Øª Ø§Ù„ØµÙ„Ø§Ø© ${normalizedPrayerTime} - Ø§Ù„Ø«Ø§Ù†ÙŠØ©: ${currentSeconds} âœ… âœ… âœ…`);
                } else {
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø¨ (Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø© Ù‚Ø¨Ù„)
                    const [prayerHours, prayerMinutes] = normalizedPrayerTime.split(':').map(Number);
                    if (!isNaN(prayerHours) && !isNaN(prayerMinutes)) {
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø¨ (10 Ø«ÙˆØ§Ù†ÙŠ Ù‚Ø¨Ù„)
                        if (prayerHours === currentHours && prayerMinutes === currentMinutes && currentSeconds >= 50) {
                            console.log(`ğŸ”” â³ â³ â³ Ø§Ù‚ØªØ±Ø§Ø¨ Ø´Ø¯ÙŠØ¯! ØµÙ„Ø§Ø© ${prayerNames[p]}: Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ ${currentTimeFull} - ÙˆÙ‚Øª Ø§Ù„ØµÙ„Ø§Ø© ${normalizedPrayerTime} - Ù…ØªØ¨Ù‚Ù‰ ${60 - currentSeconds} Ø«Ø§Ù†ÙŠØ© â³ â³ â³`);
                        } else if (prayerHours === currentHours && prayerMinutes === currentMinutes + 1 && currentSeconds >= 50) {
                            console.log(`ğŸ”” â³ Ø§Ù‚ØªØ±Ø§Ø¨! ØµÙ„Ø§Ø© ${prayerNames[p]}: Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ ${currentTimeFull} - ÙˆÙ‚Øª Ø§Ù„ØµÙ„Ø§Ø© ${normalizedPrayerTime} - Ù…ØªØ¨Ù‚Ù‰ Ø£Ù‚Ù„ Ù…Ù† Ø¯Ù‚ÙŠÙ‚Ø©`);
                        }
                    }
                }
                
                return matches;
            });
            
            // Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ´Ø®ÙŠØµ Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ ØªØ·Ø§Ø¨Ù‚
            if (prayerName) {
                console.log(`ğŸ” ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙ„Ø§Ø© Ù…ØªØ·Ø§Ø¨Ù‚Ø©: ${prayerNames[prayerName]} ÙÙŠ ${currentTimeFull}`);
            }
            
            // Ø¨Ø¯Ø¡ Ø§Ù„Ø£Ø°Ø§Ù† ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ Ø¯Ø®ÙˆÙ„ ÙˆÙ‚Øª Ø§Ù„ØµÙ„Ø§Ø©
            // Ù†Ø³ØªØ®Ø¯Ù… triggerKey Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©
            const triggerKey = `${prayerName}-${currentTime}`;
            
            // Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ´Ø®ÙŠØµ Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ ØªØ·Ø§Ø¨Ù‚
            if (prayerName) {
                console.log(`ğŸ” ğŸ” ğŸ” ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙ„Ø§Ø© Ù…ØªØ·Ø§Ø¨Ù‚Ø©: ${prayerNames[prayerName]} ÙÙŠ ${currentTimeFull} ğŸ” ğŸ” ğŸ”`);
                console.log(`ğŸ”‘ triggerKey: ${triggerKey}`);
                console.log(`ğŸ”‘ lastTriggeredTime: ${lastTriggeredTime}`);
                console.log(`ğŸ”‘ Ù‡Ù„ triggerKey !== lastTriggeredTime? ${triggerKey !== lastTriggeredTime}`);
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ù‡Ø°Ù‡ Ø§Ù„ØµÙ„Ø§Ø© Ù„Ù… ÙŠØªÙ… ØªØ´ØºÙŠÙ„Ù‡Ø§ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©
            if (prayerName && triggerKey !== lastTriggeredTime) {
                console.log(`â° â° â° â° â° ÙˆÙ‚Øª ØµÙ„Ø§Ø© ${prayerNames[prayerName]} â° â° â° â° â°`);
                console.log(`ğŸ“Š Ø§Ù„ØªÙØ§ØµÙŠÙ„:`, {
                    prayerName: prayerName,
                    currentTime: currentTimeFull,
                    prayerTime: prayerTimes[prayerName],
                    currentPhase: state.currentPhase,
                    isAdhanPlaying: state.isAdhanPlaying,
                    currentSeconds: currentSeconds,
                    triggerKey: triggerKey,
                    lastTriggeredTime: lastTriggeredTime
                });
                
                // ØªØ­Ø¯ÙŠØ« lastTriggeredTime ÙÙˆØ±Ø§Ù‹ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
                lastTriggeredTime = triggerKey;
                lastTriggeredPrayer = prayerName;
                
                console.log('ğŸš€ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø°Ø§Ù†...');
                
                // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ triggerAdhan Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø± ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª
                // triggerAdhan Ø³ØªØ­Ø§ÙˆÙ„ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¯Ø§Ø®Ù„ÙŠØ§Ù‹
                console.log('ğŸ¯ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ triggerAdhan Ù…Ø¨Ø§Ø´Ø±Ø©...');
                triggerAdhan(prayerName);
            } else if (prayerName && triggerKey === lastTriggeredTime) {
                // ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø°Ø§Ù† Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©
                if (currentSeconds === 0 || currentSeconds === 1) {
                    console.log(`â„¹ï¸ Ø§Ù„Ø£Ø°Ø§Ù† ØªÙ… ØªØ´ØºÙŠÙ„Ù‡ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù„ØµÙ„Ø§Ø© ${prayerNames[prayerName]}`);
                }
            }
        }
        
        function triggerAdhan(prayerName) {
            console.log(`ğŸš€ğŸš€ğŸš€ triggerAdhan() - ØµÙ„Ø§Ø©: ${prayerName} ğŸš€ğŸš€ğŸš€`);
            
            if (!prayerName) {
                console.error('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø³Ù… ØµÙ„Ø§Ø©!');
                return;
            }
            
            state.activePrayer = prayerName;
            state.currentPhase = 'adhan';
            
            console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©:', {
                activePrayer: state.activePrayer,
                currentPhase: state.currentPhase
            });
            
            // Ø¹Ø±Ø¶ ØµÙˆØ±Ø© Ø§Ù„Ø£Ø°Ø§Ù† ÙÙˆØ±Ø§Ù‹ ÙÙŠ Ø£ÙˆÙ„ Ø«Ø§Ù†ÙŠØ©
            console.log('ğŸ–¼ï¸ Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ø°Ø§Ù†...');
            renderAdhan();
            
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„ÙØ§Øª Ø§Ù„Ø£Ø°Ø§Ù†
            let adhanFile = '';
            if (prayerName === 'fajr') {
                adhanFile = state.settings.fajrAdhanSound || 'audio/audio_fajr.mp3';
            } else {
                adhanFile = state.settings.adhanSound || 'audio/audio_dhar.mp3';
            }
            
            console.log(`ğŸµ Ø³ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø£Ø°Ø§Ù†: ${adhanFile}`, {
                hasFajrSound: !!state.settings.fajrAdhanSound,
                hasRegularSound: !!state.settings.adhanSound,
                isFajr: prayerName === 'fajr'
            });
            
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¹Ù†ØµØ± Ø§Ù„ØµÙˆØª
            const audioRef = document.getElementById('audioRef');
            if (!audioRef) {
                console.error('âŒ audioRef ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
                // Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ audioRefØŒ Ù†Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ø¨Ø¹Ø¯ Ù…Ø¯Ø© Ø§Ù„Ø£Ø°Ø§Ù†
                const adhanDuration = (state.settings.adhanDurationMinutes * 60 + state.settings.adhanDurationSeconds) * 1000;
                setTimeout(() => {
                    console.log('â° Ø§Ù†ØªÙ‡Øª Ù…Ø¯Ø© Ø§Ù„Ø£Ø°Ø§Ù† (Ø¨Ø¯ÙˆÙ† ØµÙˆØª) - Ø¨Ø¯Ø¡ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©');
                    startIqamaCountdown();
                }, adhanDuration);
                return;
            }
            
            // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ startAdhan Ù…Ø¨Ø§Ø´Ø±Ø© - Ø³ØªØ­Ø§ÙˆÙ„ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¯Ø§Ø®Ù„ÙŠØ§Ù‹ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
            console.log('ğŸ¯ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ startAdhan Ù…Ø¨Ø§Ø´Ø±Ø©...');
            startAdhan();
        }

        function checkIqamaCountdown() {
            if (state.currentPhase === 'iqamaCountdown' && state.iqamaEndTime) {
                if (new Date() >= state.iqamaEndTime) {
                    state.iqamaEndTime = null;
                    startPhoneImage();
                }
            }
        }

        // ==================== ADHAN LOGIC ====================
        function startAdhan() {
            console.log('ğŸ”ŠğŸ”ŠğŸ”Š Ø¨Ø¯Ø¡ Ø¯Ø§Ù„Ø© startAdhan() ğŸ”ŠğŸ”ŠğŸ”Š');
            console.log('ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø°Ø§Ù†:', {
                isAdhanPlaying: state.isAdhanPlaying,
                activePrayer: state.activePrayer,
                currentPhase: state.currentPhase,
                isMuted: state.settings.isMuted,
                volume: state.settings.volume,
                audioUnlocked: state.audioUnlocked
            });
            
            if (state.isAdhanPlaying) {
                console.log('âš ï¸ Ø§Ù„Ø£Ø°Ø§Ù† Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨Ø§Ù„ÙØ¹Ù„ - Ø¥ÙŠÙ‚Ø§Ù');
                return;
            }
            
            if (!state.activePrayer) {
                console.error('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØµÙ„Ø§Ø© Ù†Ø´Ø·Ø© - Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø°Ø§Ù†');
                return;
            }
            
            state.isAdhanPlaying = true;
            console.log('âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† isAdhanPlaying = true');
            
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø±Ø¶ ØµÙˆØ±Ø© Ø§Ù„Ø£Ø°Ø§Ù† (ØªÙ… Ø¹Ø±Ø¶Ù‡Ø§ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ triggerAdhanØŒ Ù„ÙƒÙ† Ù†Ø¹ÙŠØ¯ Ø§Ù„ØªØ£ÙƒØ¯)
            if (state.currentPhase === 'adhan') {
                console.log('ğŸ–¼ï¸ Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ø°Ø§Ù†...');
                renderAdhan();
            }
            
            const prayerName = state.activePrayer;
            let adhanFile = '';
            if (prayerName === 'fajr') {
                adhanFile = state.settings.fajrAdhanSound || 'audio/audio_fajr.mp3';
            } else {
                adhanFile = state.settings.adhanSound || 'audio/audio_dhar.mp3';
            }
            
            console.log('ğŸµ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø°Ø§Ù†:', {
                prayerName: prayerName,
                adhanFile: adhanFile ? adhanFile.substring(0, 100) + '...' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù',
                hasFajrSound: !!state.settings.fajrAdhanSound,
                hasRegularSound: !!state.settings.adhanSound,
                fileLength: adhanFile ? adhanFile.length : 0,
                isDataURL: adhanFile ? adhanFile.startsWith('data:') : false,
                fajrSoundLength: state.settings.fajrAdhanSound ? state.settings.fajrAdhanSound.length : 0,
                regularSoundLength: state.settings.adhanSound ? state.settings.adhanSound.length : 0
            });
            
            const adhanDuration = (state.settings.adhanDurationMinutes * 60 + state.settings.adhanDurationSeconds) * 1000;
            console.log(`â±ï¸ Ù…Ø¯Ø© Ø§Ù„Ø£Ø°Ø§Ù†: ${state.settings.adhanDurationMinutes} Ø¯Ù‚ÙŠÙ‚Ø© Ùˆ ${state.settings.adhanDurationSeconds} Ø«Ø§Ù†ÙŠØ© = ${adhanDuration}ms`);
            
            const audioRef = document.getElementById('audioRef');
            console.log('ğŸ”Š Ù…Ø¹Ù„ÙˆÙ…Ø§Øª audio element:', {
                audioRefExists: !!audioRef,
                audioUnlocked: state.audioUnlocked,
                isMuted: state.settings.isMuted,
                volume: state.settings.volume
            });
            
            if (!audioRef) {
                console.error('âŒ audioRef ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
                setTimeout(() => startIqamaCountdown(), adhanDuration);
                return;
            }
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø°Ø§Ù† Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù† Ø§Ù„ØµÙˆØª Ù…Ø¹Ø·Ù„Ø§Ù‹ (Ù„ÙƒÙ† Ø³Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø©)
            if (adhanFile) {
                console.log('ğŸµ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø°Ø§Ù†...', {
                    isMuted: state.settings.isMuted,
                    hasFile: !!adhanFile,
                    filePath: adhanFile.substring(0, 100),
                    audioUnlocked: state.audioUnlocked
                });
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ù‚Ø¨Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„
                // Ù†Ø¨Ø¯Ø£ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø°Ø§Ù† Ù…Ø¨Ø§Ø´Ø±Ø© - Ø§Ù„ØµÙˆØª Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„
                console.log('ğŸµ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø°Ø§Ù† Ù…Ø¨Ø§Ø´Ø±Ø©...');
                playAdhanAudio();
            } else {
                console.log('ğŸ”‡ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù Ø£Ø°Ø§Ù† - Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ù…Ø¯Ø© Ø§Ù„Ø£Ø°Ø§Ù† Ø«Ù… Ø¨Ø¯Ø¡ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©');
                setTimeout(() => {
                    console.log('â° Ø§Ù†ØªÙ‡Øª Ù…Ø¯Ø© Ø§Ù„Ø£Ø°Ø§Ù† (Ø¨Ø¯ÙˆÙ† Ù…Ù„Ù) - Ø¨Ø¯Ø¡ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©');
                    startIqamaCountdown();
                }, adhanDuration);
            }
            
            // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª
            function playAdhanAudio() {
                console.log('ğŸµ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø£Ø°Ø§Ù†...');
                
                // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
                audioRef.onended = null;
                audioRef.onerror = null;
                audioRef.onloadstart = null;
                
                // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØµØ¯Ø± ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                console.log('ğŸ“ ØªØ¹ÙŠÙŠÙ† Ù…Ù„Ù Ø§Ù„Ø£Ø°Ø§Ù†:', {
                    adhanFileType: typeof adhanFile,
                    adhanFileLength: adhanFile ? adhanFile.length : 0,
                    isDataURL: adhanFile ? adhanFile.startsWith('data:') : false,
                    preview: adhanFile ? adhanFile.substring(0, 50) + '...' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù'
                });
                
                audioRef.src = adhanFile;
                audioRef.currentTime = 0;
                audioRef.volume = state.settings.volume;
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…Ø¹Ø·Ù‘Ù„
                audioRef.muted = false; // Ù†Ø¶Ø¨Ø·Ù‡ Ø¹Ù„Ù‰ false Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ´ØºÙŠÙ„
                
                console.log('ğŸ”Š Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:', {
                    volume: audioRef.volume,
                    muted: audioRef.muted,
                    src: audioRef.src ? (audioRef.src.length > 100 ? audioRef.src.substring(0, 100) + '...' : audioRef.src) : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯',
                    srcLength: audioRef.src ? audioRef.src.length : 0,
                    audioUnlocked: state.audioUnlocked,
                    isMuted: state.settings.isMuted
                });
                
                // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ø¦Ù„ ØªÙˆØ¶ÙŠØ­ÙŠØ©
                console.log(`ğŸµ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù„Ù Ø§Ù„Ø£Ø°Ø§Ù†: ${adhanFile}`);
                console.log(`ğŸ”Š Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª: Ø­Ø¬Ù…=${audioRef.volume}, ÙƒØªÙ…=${audioRef.muted}`);
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹
                const loadPromise = audioRef.load();
                if (loadPromise) {
                    loadPromise.catch(e => {
                        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø£Ø°Ø§Ù†:', e);
                    });
                }
                
                // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
                audioRef.onended = () => {
                    console.log('ğŸµ âœ… Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø£Ø°Ø§Ù† Ø§Ù„ØµÙˆØªÙŠ - Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù„Ø¥Ù‚Ø§Ù…Ø©');
                    state.isAdhanPlaying = false;
                    startIqamaCountdown();
                };
                
                audioRef.onerror = (e) => {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø°Ø§Ù†:', e);
                    console.error('âŒ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:', {
                        error: audioRef.error,
                        errorCode: audioRef.error ? audioRef.error.code : null,
                        errorMessage: audioRef.error ? audioRef.error.message : null,
                        src: audioRef.src
                    });
                    state.isAdhanPlaying = false;
                    setTimeout(() => startIqamaCountdown(), adhanDuration);
                };
                
                audioRef.onloadstart = () => {
                    console.log('ğŸ“¥ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø£Ø°Ø§Ù†...');
                };
                
                audioRef.oncanplay = () => {
                    console.log('âœ… Ù…Ù„Ù Ø§Ù„Ø£Ø°Ø§Ù† Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ´ØºÙŠÙ„');
                };
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„
                const playPromise = audioRef.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('âœ… âœ… âœ… ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø°Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­! âœ… âœ… âœ…');
                        console.log('ğŸµ Ø§Ù„Ø£Ø°Ø§Ù† ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†:', {
                            currentTime: audioRef.currentTime,
                            duration: audioRef.duration,
                            volume: audioRef.volume,
                            muted: audioRef.muted
                        });
                    }).catch((e) => {
                        console.error('âŒ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø°Ø§Ù†:', e);
                        console.error('âŒ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:', {
                            name: e.name,
                            message: e.message,
                            stack: e.stack
                        });
                        state.isAdhanPlaying = false;
                        console.log(`â³ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ù…Ø¯Ø© ${adhanDuration / 1000} Ø«Ø§Ù†ÙŠØ© Ø«Ù… Ø¨Ø¯Ø¡ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©`);
                        setTimeout(() => startIqamaCountdown(), adhanDuration);
                    });
                } else {
                    console.warn('âš ï¸ play() Ù„Ù… ÙŠÙØ±Ø¬Ø¹ promise');
                    state.isAdhanPlaying = false;
                    setTimeout(() => startIqamaCountdown(), adhanDuration);
                }
            }
        }

        function startIqamaCountdown() {
            state.isAdhanPlaying = false;
            const prayerName = state.activePrayer;
            const duration = state.settings.iqamaCountdown[prayerName] || 0;
            
            if (duration <= 0) {
                startPhoneImage();
                return;
            }
            
            state.currentPhase = 'iqamaCountdown';
            state.iqamaEndTime = new Date(Date.now() + duration * 60 * 1000);
            renderIqamaCountdown();
        }

        function startPhoneImage() {
            state.currentPhase = 'phoneImage';
            renderPhoneImage();
            
            const phoneImageDuration = (state.settings.phoneImageDurationMinutes * 60 + state.settings.phoneImageDurationSeconds) * 1000;

            console.log(`â° Ø¨Ø¯Ø¡ Ø¹Ø±Ø¶ ØµÙˆØ±Ø© Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù…Ø¯Ø©: ${state.settings.phoneImageDurationMinutes} Ø¯Ù‚ÙŠÙ‚Ø© Ùˆ ${state.settings.phoneImageDurationSeconds} Ø«Ø§Ù†ÙŠØ©`);

            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ Ù…Ø¤Ù‚Øª Ø³Ø§Ø¨Ù‚
            if (state.phoneImageTimer) {
                clearTimeout(state.phoneImageTimer);
            }
            
            if (phoneImageDuration > 0) {
                // Ø­ÙØ¸ Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù„Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¥Ù„ØºØ§Ø¤Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§
                state.phoneImageTimer = setTimeout(() => {
                    console.log('â° Ø§Ù†ØªÙ‡Øª Ù…Ø¯Ø© Ø¹Ø±Ø¶ ØµÙˆØ±Ø© Ø§Ù„Ù‡Ø§ØªÙ - Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø°ÙƒØ§Ø±');
                    startAzkar();
                }, phoneImageDuration);
            } else {
                console.log('â° Ù…Ø¯Ø© Ø¹Ø±Ø¶ ØµÙˆØ±Ø© Ø§Ù„Ù‡Ø§ØªÙ ØµÙØ±ÙŠØ© - Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„ÙÙˆØ±ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø°ÙƒØ§Ø±');
                startAzkar();
            }
        }

        function startAzkar() {
            state.currentPhase = 'azkar';
            state.currentAzkarIndex = 0;
            renderAzkar();
            
            const azkarDuration = (state.settings.azkarDurationMinutes * 60 + state.settings.azkarDurationSeconds) * 1000;
            const displayInterval = azkarDuration > 0 ? azkarDuration / azkarAfterPrayer.length : 15000;
            
            if (state.azkarIntervalRef) {
                clearInterval(state.azkarIntervalRef);
            }
            
            state.azkarIntervalRef = setInterval(() => {
                state.currentAzkarIndex++;
                if (state.currentAzkarIndex >= azkarAfterPrayer.length) {
                    clearInterval(state.azkarIntervalRef);
                    setTimeout(() => resetToIdle(), 2000);
                } else {
                    renderAzkar();
                }
            }, displayInterval);
        }

        function resetToIdle() {
            state.currentPhase = 'idle';
            state.activePrayer = null;
            state.iqamaEndTime = null;
            state.currentAzkarIndex = 0;
            state.isAdhanPlaying = false;
            
            if (state.phaseTimeoutRef) {
                clearTimeout(state.phaseTimeoutRef);
                state.phaseTimeoutRef = null;
            }
            if (state.azkarIntervalRef) {
                clearInterval(state.azkarIntervalRef);
                state.azkarIntervalRef = null;
            }
            
            renderMainScreen();
        }

        function skipToNextPhase() {
            if (state.currentPhase === 'adhan') {
                if (state.activePrayer) startIqamaCountdown();
            } else if (state.currentPhase === 'iqamaCountdown') {
                state.iqamaEndTime = null;
                startPhoneImage();
            } else if (state.currentPhase === 'phoneImage') {
                startAzkar();
            } else if (state.currentPhase === 'azkar') {
                resetToIdle();
            }
        }

        // ==================== RENDERING FUNCTIONS ====================
        function renderAdhan() {
            const hasImage = state.settings.adhanImage && state.settings.adhanImage.length > 0;
            const positionClass = state.settings.adhanTextPosition === 'top' ? 'justify-start' : 
                                 state.settings.adhanTextPosition === 'bottom' ? 'justify-end' : 'justify-center';
            const activePrayerName = state.activePrayer ? prayerNames[state.activePrayer] : '';
            
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="min-h-screen relative flex flex-col" style="background-color: ${hasImage ? 'transparent' : '#101828'}; background-image: ${hasImage ? `url(${state.settings.adhanImage})` : 'none'}; background-size: cover; background-position: center; background-repeat: no-repeat;">
                    <div class="absolute inset-0 bg-black/70"></div>
                    <button onclick="skipToNextPhase()" class="absolute top-6 right-6 z-50 bg-red-600/80 hover:bg-red-700 text-white text-5xl font-bold rounded-full w-16 h-16 flex items-center justify-center shadow-2xl transition-all hover:scale-110" title="Ø§Ø¶ØºØ· Ù„Ù„Ø®Ø±ÙˆØ¬">Ã—</button>
                    <div class="relative z-10 flex flex-col items-center text-center gap-10 px-6 py-12 flex-1 ${positionClass}">
                        <div class="max-w-4xl w-full mx-auto flex flex-col items-center gap-10">
                            <span class="text-6xl md:text-7xl font-bold text-white drop-shadow-[0_0_20px_rgba(255,255,255,0.9)]">Ø§Ù„Ù„Ù‡ Ø£ÙƒØ¨Ø±</span>
                            <h2 class="text-5xl md:text-6xl font-bold text-white drop-shadow-[0_0_20px_rgba(255,255,255,0.9)]">Ø­Ø§Ù† Ø§Ù„Ø¢Ù† ÙˆÙ‚Øª Ø£Ø°Ø§Ù† ${activePrayerName || '...'}</h2>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderIqamaCountdown() {
            const hasBackgroundImage = state.settings.iqamaBackgroundImage && state.settings.iqamaBackgroundImage.length > 0;
            const countdown = calculateIqamaCountdown();
            const activePrayerName = state.activePrayer ? prayerNames[state.activePrayer] : '';
            
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="min-h-screen text-white flex flex-col justify-center items-center font-sans relative" style="background-color: ${hasBackgroundImage ? 'transparent' : state.settings.iqamaBackgroundColor}; background-image: ${hasBackgroundImage ? `url(${state.settings.iqamaBackgroundImage})` : 'none'}; background-size: cover; background-position: center; background-repeat: no-repeat;">
                    <button onclick="skipToNextPhase()" class="absolute top-6 right-6 z-50 bg-red-600/80 hover:bg-red-700 text-white text-5xl font-bold rounded-full w-16 h-16 flex items-center justify-center shadow-2xl transition-all hover:scale-110" title="Ø§Ø¶ØºØ· Ù„Ù„Ø®Ø±ÙˆØ¬">Ã—</button>
                    <div class="flex-grow flex flex-col justify-center items-center text-center p-8">
                        <h2 class="text-6xl sm:text-7xl md:text-8xl font-bold mb-8" style="color: ${state.settings.colors.iqamaCountdownTextColor}">Ø¥Ù‚Ø§Ù…Ø© ØµÙ„Ø§Ø© ${activePrayerName}</h2>
                        <div id="iqama-countdown-display" class="font-mono text-[12vw] sm:text-[15vw] font-bold tracking-widest" style="text-shadow: 0 0 25px #fff; color: ${state.settings.colors.iqamaCountdownTextColor}">${countdown || '00:00'}</div>
                    </div>
                </div>
            `;
        }

        function renderPhoneImage() {
            const hasBackgroundImage = state.settings.phoneImage && state.settings.phoneImage.length > 0;
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="min-h-screen flex items-center justify-center relative" style="background-color: ${hasBackgroundImage ? 'transparent' : '#000000'}; background-image: ${hasBackgroundImage ? `url(${state.settings.phoneImage})` : 'none'}; background-size: cover; background-position: center; background-repeat: no-repeat;">
                    <button onclick="skipToNextPhase()" class="absolute top-6 right-6 z-50 bg-red-600/80 hover:bg-red-700 text-white text-5xl font-bold rounded-full w-16 h-16 flex items-center justify-center shadow-2xl transition-all hover:scale-110" title="Ø§Ø¶ØºØ· Ù„Ù„Ø®Ø±ÙˆØ¬">Ã—</button>
                    ${!hasBackgroundImage ? 
                        `<div class="text-white text-6xl font-bold text-center p-8">
                            <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‡Ø§ØªÙ</p>
                            <p class="text-4xl mt-8">ğŸ“µ</p>
                        </div>` : ''
                    }
                    }
                </div>
            `;
        }

        function renderAzkar() {
            const currentAzkar = azkarAfterPrayer[state.currentAzkarIndex % azkarAfterPrayer.length];
            const hasBackgroundImage = state.settings.azkarBackgroundImage && state.settings.azkarBackgroundImage.length > 0;
            
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="min-h-screen text-white flex items-center justify-center p-8 relative bg-cover bg-center" style="background-image: ${hasBackgroundImage ? `url(${state.settings.azkarBackgroundImage})` : 'none'}; background-color: ${hasBackgroundImage ? 'transparent' : '#1e40af'};">
                    <div class="absolute inset-0 bg-black/70"></div>
                    <button onclick="skipToNextPhase()" class="absolute top-6 right-6 z-50 bg-red-600/80 hover:bg-red-700 text-white text-5xl font-bold rounded-full w-16 h-16 flex items-center justify-center shadow-2xl transition-all hover:scale-110" title="Ø§Ø¶ØºØ· Ù„Ù„Ø®Ø±ÙˆØ¬">Ã—</button>
                    <div class="max-w-4xl text-center z-10">
                        <h2 class="text-5xl font-bold mb-12" style="color: ${state.settings.colors.azkarTextColor}">Ø£Ø°ÙƒØ§Ø± Ù…Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØµÙ„Ø§Ø©</h2>
                        <p class="text-5xl leading-relaxed whitespace-pre-line font-semibold" style="color: ${state.settings.colors.azkarTextColor}">${currentAzkar}</p>
                        <div class="mt-12 text-xl opacity-70" style="color: ${state.settings.colors.azkarTextColor}">(${state.currentAzkarIndex + 1} / ${azkarAfterPrayer.length})</div>
                    </div>
                </div>
            `;
        }

        function calculateIqamaCountdown() {
            if (!state.iqamaEndTime) return null;
            const diff = state.iqamaEndTime.getTime() - state.currentTime.getTime();
            if (diff <= 0) return '00:00';
            const minutes = Math.floor(diff / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function calculateNextPrayer() {
            const toMinutes = (s) => {
                if (!s || !s.includes(':')) return null;
                const [hStr, mStr] = s.split(':');
                const h = parseInt(hStr, 10);
                const m = parseInt(mStr, 10);
                if (Number.isNaN(h) || Number.isNaN(m)) return null;
                return h * 60 + m;
            };

            const currentMinutes = state.currentTime.getHours() * 60 + state.currentTime.getMinutes();
            const currentSeconds = state.currentTime.getSeconds();
            
            const schedule = PRAYER_ORDER
                .map(name => ({ name, min: toMinutes(state.settings.prayerTimes[name]) }))
                .filter(p => p.min != null);

            let next = schedule.find(p => p.min > currentMinutes);

            if (!next) {
                const fajrMin = toMinutes(state.settings.prayerTimes.fajr);
                if (fajrMin == null) {
                    return { nextPrayerName: '...', countdown: '--:--:--' };
                }
                
                const diffSec = ((fajrMin + 1440) * 60) - (currentMinutes * 60 + currentSeconds);
                const hours = Math.floor(diffSec / 3600);
                const minutes = Math.floor((diffSec % 3600) / 60);
                const seconds = diffSec % 60;
                
                return {
                    nextPrayerName: prayerNames.fajr,
                    countdown: `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`,
                };
            }

            const diffSec = (next.min * 60) - (currentMinutes * 60 + currentSeconds);
            const hours = Math.floor(diffSec / 3600);
            const minutes = Math.floor((diffSec % 3600) / 60);
            const seconds = diffSec % 60;

            return {
                nextPrayerName: prayerNames[next.name],
                countdown: `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`,
            };
        }

        function renderMainScreen() {
            const { nextPrayerName, countdown } = calculateNextPrayer();
            const nowTz = state.currentTime;
            
            const hour = String(nowTz.getHours()).padStart(2, '0');
            const minute = String(nowTz.getMinutes()).padStart(2, '0');
            const second = String(nowTz.getSeconds()).padStart(2, '0');
            const dayPeriod = state.settings.timeFormat === '12h' ? 
                (nowTz.getHours() >= 12 ? 'PM' : 'AM') : null;
            const hour12 = state.settings.timeFormat === '12h' ? 
                (nowTz.getHours() % 12 || 12) : nowTz.getHours();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø®Ù„ÙÙŠØ©
            const hasBackground = state.settings.backgroundImage && state.settings.backgroundImage.length > 0;
            const backgroundStyle = hasBackground ? 
                `background-image: url(${state.settings.backgroundImage}); background-size: cover; background-position: center; background-repeat: no-repeat;` : 
                'background-color: #263138;';
            
            console.log('ğŸ¨ Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:', {
                hasBackgroundImage: hasBackground,
                backgroundImageLength: state.settings.backgroundImage ? state.settings.backgroundImage.length : 0,
                backgroundImagePreview: state.settings.backgroundImage ? state.settings.backgroundImage.substring(0, 50) + '...' : 'none'
            });
            
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="bg-cover bg-center min-h-screen flex flex-col p-4 sm:p-6 lg:p-8 font-sans transition-all duration-1000 relative" style="${backgroundStyle} color: ${state.settings.colors.textColor};">
                    <div class="absolute inset-0 bg-black/60 -z-10"></div>
                    <header class="flex justify-between items-start">
                        <div class="flex items-center gap-4 text-2xl">
                            ${state.settings.showWeather ? `
                                <div class="flex items-center gap-2">
                                    <span>${state.settings.temperature}Â°</span>
                                    <svg class="text-yellow-400" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                                </div>
                            ` : ''}
                            ${state.isOffline ? `<svg class="text-red-400" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" title="ØºÙŠØ± Ù…ØªØµÙ„"><line x1="1" y1="1" x2="23" y2="23"></line><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"></path><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"></path><line x1="1.42" y1="1.42" x2="23" y2="23"></line><path d="M23 12.55a11.93 11.93 0 0 1-2.33 3.5"></path><path d="M2 2l20 20"></path></svg>` : ''}
                        </div>
                        <h1 class="text-4xl md:text-5xl font-bold text-center flex-grow">${state.settings.mosqueName}</h1>
                        <button onclick="openSettings()" class="bg-transparent hover:bg-accent p-2 rounded-md" aria-label="Open settings">
                            <svg class="h-8 w-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"></path></svg>
                        </button>
                    </header>

                    <main class="flex-grow flex flex-col justify-center items-center text-center my-4">
                        <div class="flex justify-around items-center w-full max-w-5xl">
                            <div class="flex flex-col justify-center rounded-2xl p-4 text-center shadow-lg border border-blue-600/50" style="width: 235px; height: 135px; background-color: ${state.settings.colors.shuruqBoxColor};">
                                <h3 class="text-2xl font-bold">Ø§Ù„Ø´Ø±ÙˆÙ‚</h3>
                                <p class="text-3xl font-mono font-bold">${formatPrayerTime(state.settings.shuruqTime, state.settings.timeFormat, nowTz)}</p>
                            </div>

                            <div class="rounded-2xl p-4 md:p-6 shadow-2xl border border-blue-500/50 w-[90%] max-w-2xl mx-4" style="background-color: ${state.settings.colors.clockBoxColor};">
                                <div class="flex justify-center items-baseline">
                                    <span class="text-8xl md:text-9xl font-bold tracking-tighter" style="text-shadow: 0 0 15px #fff;">${hour12}:${minute}</span>
                                    <div class="flex flex-col items-start ml-2 md:ml-4">
                                        <span class="text-3xl md:text-5xl font-bold" style="text-shadow: 0 0 10px #fff;">${second}</span>
                                        ${dayPeriod ? `<span class="text-2xl md:text-4xl font-bold" style="text-shadow: 0 0 8px #fff;">${dayPeriod}</span>` : ''}
                                    </div>
                                </div>
                                <div class="mt-2 text-lg md:text-xl space-y-1">
                                    <p>${formatHijriDate(nowTz)}</p>
                                    <p>${formatGregorianDate(nowTz)}</p>
                                </div>
                            </div>

                            <div class="flex flex-col justify-center rounded-2xl p-4 text-center shadow-lg border border-blue-600/50" style="width: 235px; height: 135px; background-color: ${state.settings.colors.jumuahBoxColor};">
                                <h3 class="text-2xl font-bold">Ø§Ù„Ø¬Ù…Ø¹Ø©</h3>
                                <p class="text-3xl font-mono font-bold">${formatPrayerTime(state.settings.jumuahTime, state.settings.timeFormat, nowTz)}</p>
                            </div>
                        </div>

                        <div class="mt-8 text-3xl font-semibold flex flex-col items-center gap-2">
                            ${state.isFetchingTimes ? `
                                <div class="flex items-center gap-3">
                                    <svg class="animate-spin h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>
                                    <span>Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ„Ø§Ø©...</span>
                                </div>
                            ` : `
                                <div class="flex items-center gap-3" style="color: ${state.settings.colors.nextPrayerTextColor};">
                                    <svg class="text-yellow-400" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                                    <span>Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</span>
                                    <svg class="text-yellow-400" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                                </div>
                                <span class="text-5xl font-bold" style="color: ${state.settings.colors.nextPrayerTextColor};">${nextPrayerName}</span>
                                <span class="font-mono text-4xl" style="color: ${state.settings.colors.nextPrayerTextColor};">ØªØ¨Ù‚Ù‰ ${countdown}</span>
                            `}
                        </div>
                    </main>
                    
                    <footer class="w-full max-w-7xl mx-auto mt-auto">
                        <div class="grid grid-cols-5 gap-3 md:gap-6 justify-items-center max-w-7xl mx-auto">
                            ${PRAYER_ORDER.map((key) => {
                                const isNext = prayerNames[key] === nextPrayerName && !state.isFetchingTimes;
                                return `
                                    <div class="rounded-2xl p-3 text-center shadow-lg border border-blue-600/50 transition-all flex flex-col justify-center ${isNext ? 'border-yellow-400 border-2 scale-105' : ''}" style="width: 200px; height: 110px; background-color: ${state.settings.colors.prayerBoxesColor};">
                                        <h3 class="text-2xl font-bold">${prayerNames[key]}</h3>
                                        <p class="text-3xl font-mono font-bold">${formatPrayerTime(state.settings.prayerTimes[key], state.settings.timeFormat, nowTz)}</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </footer>
                </div>
            `;
        }

        function updateUI() {
            if (state.currentPhase === 'idle') {
                renderMainScreen();
                // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                startPrayerMonitoring();
            } else if (state.currentPhase === 'iqamaCountdown') {
                // Update countdown every second
                const countdown = calculateIqamaCountdown();
                const countdownEl = document.getElementById('iqama-countdown-display');
                if (countdownEl) {
                    countdownEl.textContent = countdown || '00:00';
                }
            } else if (state.currentPhase === 'azkar') {
                // Azkar doesn't need frequent updates
            }
        }

        // ==================== SETTINGS PANEL ====================
        function openSettings() {
            state.isPanelOpen = true;
            document.getElementById('settings-overlay').classList.add('open');
            document.getElementById('settings-panel').classList.add('open');
            renderSettingsPanel();
        }

        function closeSettings() {
            state.isPanelOpen = false;
            document.getElementById('settings-overlay').classList.remove('open');
            document.getElementById('settings-panel').classList.remove('open');
        }

        function renderSettingsPanel() {
            const content = document.getElementById('settings-content');
            const localSettings = JSON.parse(JSON.stringify(state.settings));
            
            content.innerHTML = `
                <div class="space-y-6">
                    <!-- General Settings -->
                    <div class="border-b pb-4">
                        <h3 class="text-lg font-semibold mb-4 cursor-pointer" onclick="toggleAccordion('general')">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø© â–¼</h3>
                        <div id="accordion-general" class="accordion-content open">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¬Ø¯</label>
                                    <input type="text" id="mosque-name" value="${localSettings.mosqueName}" class="w-full px-3 py-2 bg-input border border-border rounded-md text-foreground" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Ø§Ù„Ø¯ÙˆÙ„Ø©</label>
                                    <select id="country" class="w-full px-3 py-2 bg-input border border-border rounded-md text-foreground" onchange="updateCities()">
                                        ${countries.map(c => `<option value="${c}" ${c === localSettings.country ? 'selected' : ''}>${c}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
                                    <div class="flex gap-2">
                                        <select id="city" class="flex-1 px-3 py-2 bg-input border border-border rounded-md text-foreground" onchange="updatePrayerTimesOnLocationChange()">
                                            ${(citiesByCountry[localSettings.country] || []).map(c => `<option value="${c}" ${c === localSettings.city ? 'selected' : ''}>${c}</option>`).join('')}
                                        </select>
                                        <button onclick="fetchPrayerTimes(true)" class="px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90" id="refresh-btn">
                                            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Iqama Countdown -->
                    <div class="border-b pb-4">
                        <h3 class="text-lg font-semibold mb-4 cursor-pointer" onclick="toggleAccordion('iqama')">Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© â–¼</h3>
                        <div id="accordion-iqama" class="accordion-content">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">ØµÙˆØ±Ø© Ø®Ù„ÙÙŠØ© Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©</label>
                                    <input type="file" id="iqama-background-image" accept="image/*" class="w-full px-3 py-2 bg-input border border-border rounded-md text-foreground" onchange="handleFileChange('iqamaBackgroundImage', this)" />
                                </div>
                                ${PRAYER_ORDER.map(prayer => `
                                    <div>
                                        <label class="block text-sm font-medium mb-2">${prayerNames[prayer]} (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚)</label>
                                        <input type="number" id="iqama-${prayer}" value="${localSettings.iqamaCountdown[prayer]}" class="w-full px-3 py-2 bg-input border border-border rounded-md text-foreground" />
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Prayer Times -->
                    <div class="border-b pb-4">
                        <h3 class="text-lg font-semibold mb-4 cursor-pointer" onclick="toggleAccordion('prayer-times')">Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© (ÙŠØ¯ÙˆÙŠ) â–¼</h3>
                        <div id="accordion-prayer-times" class="accordion-content">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Ø§Ù„Ø´Ø±ÙˆÙ‚</label>
                                    <input type="time" id="shuruq-time" value="${localSettings.shuruqTime}" class="w-full px-3 py-2 bg-input border border-border rounded-md text-foreground" />
                                    <label class="block text-sm font-medium mb-2 mt-2">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø±ÙˆÙ‚ (Ø¯Ù‚Ø§Ø¦Ù‚)</label>
                                    <input type="number" id="shuruq-offset" value="${localSettings.shuruqOffset || 0}" class="w-full px-3 py-2 bg-input border border-border rounded-md text-foreground" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Ø§Ù„Ø¬Ù…Ø¹Ø©</label>
                                    <input type="time" id="jumuah-time" value="${localSettings.jumuahTime}" class="w-full px-3 py-2 bg-input border border-border rounded-md text-foreground" />
                                    <label class="block text-sm font-medium mb-2 mt-2">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ù…Ø¹Ø© (Ø¯Ù‚Ø§Ø¦Ù‚)</label>
                                    <input type="number" id="jumuah-offset" value="${localSettings.jumuahOffset || 0}" class="w-full px-3 py-2 bg-input border border-border rounded-md text-foreground" />
                                </div>
                                ${PRAYER_ORDER.map(prayer => `
                                    <div>
                                        <label class="block text-sm font-medium mb-2">${prayerNames[prayer]}</label>
                                        <input type="time" id="prayer-${prayer}" value="${localSettings.prayerTimes[prayer]}" class="w-full px-3 py-2 bg-input border border-border rounded-md text-foreground" />
                                        <label class="block text-sm font-medium mb-2 mt-2">ØªØ¹Ø¯ÙŠÙ„ ${prayerNames[prayer]} (Ø¯Ù‚Ø§Ø¦Ù‚)</label>
                                        <input type="number" id="prayer-offset-${prayer}" value="${(localSettings.prayerTimeOffsets && localSettings.prayerTimeOffsets[prayer]) || 0}" class="w-full px-3 py-2 bg-input border border-border rounded-md text-foreground" />
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Display Settings -->
                    <div class="border-b pb-4">
                        <h3 class="text-lg font-semibold mb-4 cursor-pointer" onclick="toggleAccordion('display')">Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ù…Ø¸Ù‡Ø± â–¼</h3>
                        <div id="accordion-display" class="accordion-content">
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <label class="text-sm font-medium">Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ†Ø³ÙŠÙ‚ 24 Ø³Ø§Ø¹Ø©</label>
                                    <input type="checkbox" id="time-format" ${localSettings.timeFormat === '24h' ? 'checked' : ''} class="w-4 h-4" />
                                </div>
                                <div class="flex items-center justify-between">
                                    <label class="text-sm font-medium">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø·Ù‚Ø³</label>
                                    <input type="checkbox" id="show-weather" ${localSettings.showWeather ? 'checked' : ''} class="w-4 h-4" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© (Ù…Ø¦ÙˆÙŠØ©)</label>
                                    <input type="number" id="temperature" value="${localSettings.temperature}" class="w-full px-3 py-2 bg-input border border-border rounded-md text-foreground" disabled />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Ù…Ø¯Ø© Ø§Ù„ØªØ¹ØªÙŠÙ… Ø¨Ø¹Ø¯ Ø§Ù„Ø£Ø°Ø§Ù† (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚)</label>
                                    <input type="number" id="dim-duration" value="${localSettings.dimDuration}" class="w-full px-3 py-2 bg-input border border-border rounded-md text-foreground" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">ØµÙˆØ±Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©</label>
                                    <input type="file" id="background-image" accept="image/*" class="w-full px-3 py-2 bg-input border border-border rounded-md text-foreground" onchange="handleFileChange('backgroundImage', this)" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Colors -->
                    <div class="border-b pb-4">
                        <h3 class="text-lg font-semibold mb-4 cursor-pointer" onclick="toggleAccordion('colors')">ØªØ®ØµÙŠØµ Ø§Ù„Ø£Ù„ÙˆØ§Ù† â–¼</h3>
                        <div id="accordion-colors" class="accordion-content">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Ù„ÙˆÙ† Ø§Ù„Ø®Ø· Ø§Ù„Ø¹Ø§Ù…</label>
                                    <input type="color" id="text-color" value="${localSettings.colors.textColor}" class="w-full h-10 p-1 border border-border rounded-md" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Ù„ÙˆÙ† Ù†Øµ Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</label>
                                    <input type="color" id="next-prayer-text-color" value="${localSettings.colors.nextPrayerTextColor}" class="w-full h-10 p-1 border border-border rounded-md" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Ù„ÙˆÙ† Ù†Øµ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù„Ø¥Ù‚Ø§Ù…Ø©</label>
                                    <input type="color" id="iqama-countdown-text-color" value="${localSettings.colors.iqamaCountdownTextColor}" class="w-full h-10 p-1 border border-border rounded-md" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Ù„ÙˆÙ† Ù†Øµ Ø§Ù„Ø£Ø°ÙƒØ§Ø±</label>
                                    <input type="color" id="azkar-text-color" value="${localSettings.colors.azkarTextColor}" class="w-full h-10 p-1 border border-border rounded-md" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø´Ø±ÙˆÙ‚</label>
                                    <input type="color" id="shuruq-box-color" value="${localSettings.colors.shuruqBoxColor}" class="w-full h-10 p-1 border border-border rounded-md" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø³Ø§Ø¹Ø©</label>
                                    <input type="color" id="clock-box-color" value="${localSettings.colors.clockBoxColor}" class="w-full h-10 p-1 border border-border rounded-md" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¬Ù…Ø¹Ø©</label>
                                    <input type="color" id="jumuah-box-color" value="${localSettings.colors.jumuahBoxColor}" class="w-full h-10 p-1 border border-border rounded-md" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„ØµÙ„Ø§Ø©</label>
                                    <input type="color" id="prayer-boxes-color" value="${localSettings.colors.prayerBoxesColor}" class="w-full h-10 p-1 border border-border rounded-md" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Audio Settings -->
                    <div class="border-b pb-4">
                        <h3 class="text-lg font-semibold mb-4 cursor-pointer" onclick="toggleAccordion('audio')">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª â–¼</h3>
                        <div id="accordion-audio" class="accordion-content">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Ù…Ù„Ù ØµÙˆØª Ø£Ø°Ø§Ù† Ø§Ù„ØµÙ„ÙˆØ§Øª (Ø§Ù„Ø¸Ù‡Ø±ØŒ Ø§Ù„Ø¹ØµØ±ØŒ Ø§Ù„Ù…ØºØ±Ø¨ØŒ Ø§Ù„Ø¹Ø´Ø§Ø¡)</label>
                                    <input type="file" id="adhan-sound" accept="audio/*" class="w-full px-3 py-2 bg-input border border-border rounded-md text-foreground" onchange="handleFileChange('adhanSound', this)" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Ù…Ù„Ù ØµÙˆØª Ø£Ø°Ø§Ù† Ø§Ù„ÙØ¬Ø± (Ù…Ù†ÙØµÙ„)</label>
                                    <input type="file" id="fajr-adhan-sound" accept="audio/*" class="w-full px-3 py-2 bg-input border border-border rounded-md text-foreground" onchange="handleFileChange('fajrAdhanSound', this)" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª</label>
                                    <div class="flex items-center gap-2">
                                        <button onclick="toggleMute()" class="p-2 bg-input border border-border rounded-md hover:bg-accent">
                                            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="mute-icon">
                                                ${localSettings.isMuted ? '<line x1="1" y1="1" x2="23" y2="23"></line><path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"></path><path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line>' : '<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>'}
                                            </svg>
                                        </button>
                                        <input type="range" id="volume-slider" min="0" max="1" step="0.05" value="${localSettings.isMuted ? 0 : localSettings.volume}" class="flex-1" oninput="updateVolume(this.value)" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Prayer Phases -->
                    <div class="border-b pb-4">
                        <h3 class="text-lg font-semibold mb-4 cursor-pointer" onclick="toggleAccordion('phases')">Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØµÙ„Ø§Ø© â–¼</h3>
                        <div id="accordion-phases" class="accordion-content open">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Ù…Ø¯Ø© Ø§Ù„Ø£Ø°Ø§Ù† - Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚</label>
                                    <input type="number" id="adhan-duration-minutes" value="${localSettings.adhanDurationMinutes}" class="w-full px-3 py-2 bg-input border border-border rounded-md text-foreground" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Ù…Ø¯Ø© Ø§Ù„Ø£Ø°Ø§Ù† - Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ</label>
                                    <input type="number" id="adhan-duration-seconds" value="${localSettings.adhanDurationSeconds}" class="w-full px-3 py-2 bg-input border border-border rounded-md text-foreground" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">ØµÙˆØ±Ø© Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ø°Ø§Ù†</label>
                                    <input type="file" id="adhan-image" accept="image/*" class="w-full px-3 py-2 bg-input border border-border rounded-md text-foreground" onchange="handleFileChange('adhanImage', this)" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Ù…ÙˆØ¶Ø¹ Ù†Øµ Ø§Ù„Ø£Ø°Ø§Ù†</label>
                                    <select id="adhan-text-position" class="w-full px-3 py-2 bg-input border border-border rounded-md text-foreground">
                                        <option value="top" ${localSettings.adhanTextPosition === 'top' ? 'selected' : ''}>Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©</option>
                                        <option value="center" ${localSettings.adhanTextPosition === 'center' ? 'selected' : ''}>ÙˆØ³Ø· Ø§Ù„Ø´Ø§Ø´Ø©</option>
                                        <option value="bottom" ${localSettings.adhanTextPosition === 'bottom' ? 'selected' : ''}>Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø©</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">ØµÙˆØ±Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‡Ø§ØªÙ</label>
                                    <input type="file" id="phone-image" accept="image/*" class="w-full px-3 py-2 bg-input border border-border rounded-md text-foreground" onchange="handleFileChange('phoneImage', this)" />
                                    ${localSettings.phoneImage ? `
                                        <div class="mt-3 p-3 bg-secondary rounded-md">
                                            <img src="${localSettings.phoneImage}" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© ØµÙˆØ±Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‡Ø§ØªÙ" class="w-full max-h-48 object-contain rounded mb-2" />
                                            <button type="button" onclick="clearPhoneImage()" class="w-full bg-destructive text-destructive-foreground px-3 py-2 rounded-md text-sm hover:opacity-90">Ù…Ø³Ø­ Ø§Ù„ØµÙˆØ±Ø©</button>
                                        </div>
                                    ` : ''}
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Ù…Ø¯Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‡Ø§ØªÙ - Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚</label>
                                    <input type="number" id="phone-image-duration-minutes" value="${localSettings.phoneImageDurationMinutes}" class="w-full px-3 py-2 bg-input border border-border rounded-md text-foreground" min="0" />
                                    <p class="text-xs text-muted-foreground mt-1">Ø§Ù„Ù…Ø¯Ø© Ø§Ù„ØªÙŠ Ø³ØªÙØ¹Ø±Ø¶ ÙÙŠÙ‡Ø§ ØµÙˆØ±Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‡Ø§ØªÙ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Ù…Ø¯Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‡Ø§ØªÙ - Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ</label>
                                    <input type="number" id="phone-image-duration-seconds" value="${localSettings.phoneImageDurationSeconds}" class="w-full px-3 py-2 bg-input border border-border rounded-md text-foreground" min="0" max="59" />
                                    <p class="text-xs text-muted-foreground mt-1">Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">ØµÙˆØ±Ø© Ø®Ù„ÙÙŠØ© Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ø°ÙƒØ§Ø±</label>
                                    <input type="file" id="azkar-background-image" accept="image/*" class="w-full px-3 py-2 bg-input border border-border rounded-md text-foreground" onchange="handleFileChange('azkarBackgroundImage', this)" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Ù…Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø°ÙƒØ§Ø± - Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚</label>
                                    <input type="number" id="azkar-duration-minutes" value="${localSettings.azkarDurationMinutes}" class="w-full px-3 py-2 bg-input border border-border rounded-md text-foreground" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Ù…Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø°ÙƒØ§Ø± - Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ</label>
                                    <input type="number" id="azkar-duration-seconds" value="${localSettings.azkarDurationSeconds}" class="w-full px-3 py-2 bg-input border border-border rounded-md text-foreground" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleAccordion(id) {
            const content = document.getElementById(`accordion-${id}`);
            content.classList.toggle('open');
        }

        function updateCities() {
            const country = document.getElementById('country').value;
            const citySelect = document.getElementById('city');
            const cities = citiesByCountry[country] || [];
            citySelect.innerHTML = cities.map(c => `<option value="${c}">${c}</option>`).join('');
            if (cities.length > 0) {
                citySelect.value = cities[0];
            }
        }

        function handleFileChange(settingKey, input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    if (event.target?.result) {
                        state.settings[settingKey] = event.target.result;
                        console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: ${settingKey}`, {
                            fileSize: file.size,
                            fileType: file.type,
                            dataLength: event.target.result.length
                        });
                        // Ø­ÙØ¸ ÙÙˆØ±ÙŠ ÙÙŠ localStorage Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ù‡Ù…Ø©
                        try {
                            const savedMedia = localStorage.getItem('alMoazinMediaFiles');
                            let mediaFiles = savedMedia ? JSON.parse(savedMedia) : {};
                            mediaFiles[settingKey] = event.target.result;
                            localStorage.setItem('alMoazinMediaFiles', JSON.stringify(mediaFiles));
                            console.log(`ğŸ’¾ ØªÙ… Ø­ÙØ¸ ${settingKey} ÙÙˆØ±Ø§Ù‹ ÙÙŠ localStorage`);
                        } catch (e) {
                            console.warn(`âš ï¸ ÙØ´Ù„ Ø­ÙØ¸ ${settingKey} ÙÙˆØ±Ø§Ù‹:`, e);
                        }
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        function toggleMute() {
            state.settings.isMuted = !state.settings.isMuted;
            const audioRef = document.getElementById('audioRef');
            if (audioRef) {
                audioRef.muted = state.settings.isMuted;
            }
            renderSettingsPanel();
        }

        function updateVolume(value) {
            state.settings.volume = parseFloat(value);
            state.settings.isMuted = value == 0;
            const audioRef = document.getElementById('audioRef');
            if (audioRef) {
                audioRef.volume = state.settings.volume;
                audioRef.muted = state.settings.isMuted;
            }
            const muteIcon = document.getElementById('mute-icon');
            if (muteIcon) {
                muteIcon.innerHTML = state.settings.isMuted ? 
                    '<line x1="1" y1="1" x2="23" y2="23"></line><path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"></path><path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line>' :
                    '<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>';
            }
        }

        function clearPhoneImage() {
            state.settings.phoneImage = '';
            const phoneImageInput = document.getElementById('phone-image');
            if (phoneImageInput) {
                phoneImageInput.value = '';
            }
            try {
                const savedMedia = localStorage.getItem('alMoazinMediaFiles');
                let mediaFiles = savedMedia ? JSON.parse(savedMedia) : {};
                delete mediaFiles.phoneImage;
                localStorage.setItem('alMoazinMediaFiles', JSON.stringify(mediaFiles));
            } catch (e) {
                console.warn('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† localStorage:', e);
            }
            renderSettingsPanel();
        }

        function fetchPrayerTimes(force) {
            fetchPrayerTimesAndWeather(force);
        }

        function saveSettings() {
            try {
                console.log('ğŸ’¾ Ø¨Ø¯Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª...');
                
                // General
                const mosqueNameEl = document.getElementById('mosque-name');
                const countryEl = document.getElementById('country');
                const cityEl = document.getElementById('city');
                
                if (mosqueNameEl) state.settings.mosqueName = mosqueNameEl.value;
                if (countryEl) state.settings.country = countryEl.value;
                if (cityEl) state.settings.city = cityEl.value;
                
                // Display
                const timeFormatEl = document.getElementById('time-format');
                const showWeatherEl = document.getElementById('show-weather');
                const dimDurationEl = document.getElementById('dim-duration');
                
                if (timeFormatEl) state.settings.timeFormat = timeFormatEl.checked ? '24h' : '12h';
                if (showWeatherEl) state.settings.showWeather = showWeatherEl.checked;
                if (dimDurationEl) state.settings.dimDuration = parseInt(dimDurationEl.value) || 0;
                
                // Prayer Times
                const shuruqTimeEl = document.getElementById('shuruq-time');
                const jumuahTimeEl = document.getElementById('jumuah-time');
                const shuruqOffsetEl = document.getElementById('shuruq-offset');
                const jumuahOffsetEl = document.getElementById('jumuah-offset');
                
                if (shuruqTimeEl) state.settings.shuruqTime = shuruqTimeEl.value;
                if (jumuahTimeEl) state.settings.jumuahTime = jumuahTimeEl.value;
                if (shuruqOffsetEl) state.settings.shuruqOffset = parseInt(shuruqOffsetEl.value) || 0;
                if (jumuahOffsetEl) state.settings.jumuahOffset = parseInt(jumuahOffsetEl.value) || 0;
                
                PRAYER_ORDER.forEach(prayer => {
                    const prayerEl = document.getElementById(`prayer-${prayer}`);
                    const iqamaEl = document.getElementById(`iqama-${prayer}`);
                    const offsetEl = document.getElementById(`prayer-offset-${prayer}`);
                    if (prayerEl) {
                        const newTime = prayerEl.value;
                        state.settings.prayerTimes[prayer] = newTime;
                        console.log(`ğŸ“ Ø­ÙØ¸ ÙˆÙ‚Øª ØµÙ„Ø§Ø© ${prayerNames[prayer]}: ${newTime}`);
                    }
                    if (iqamaEl) state.settings.iqamaCountdown[prayer] = parseInt(iqamaEl.value) || 0;
                    if (offsetEl) state.settings.prayerTimeOffsets[prayer] = parseInt(offsetEl.value) || 0;
                });
                
                console.log('ğŸ“‹ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:', state.settings.prayerTimes);
                
                // Colors
                const textColorEl = document.getElementById('text-color');
                const nextPrayerTextColorEl = document.getElementById('next-prayer-text-color');
                const iqamaCountdownTextColorEl = document.getElementById('iqama-countdown-text-color');
                const azkarTextColorEl = document.getElementById('azkar-text-color');
                const shuruqBoxColorEl = document.getElementById('shuruq-box-color');
                const clockBoxColorEl = document.getElementById('clock-box-color');
                const jumuahBoxColorEl = document.getElementById('jumuah-box-color');
                const prayerBoxesColorEl = document.getElementById('prayer-boxes-color');
                
                if (textColorEl) state.settings.colors.textColor = textColorEl.value;
                if (nextPrayerTextColorEl) state.settings.colors.nextPrayerTextColor = nextPrayerTextColorEl.value;
                if (iqamaCountdownTextColorEl) state.settings.colors.iqamaCountdownTextColor = iqamaCountdownTextColorEl.value;
                if (azkarTextColorEl) state.settings.colors.azkarTextColor = azkarTextColorEl.value;
                if (shuruqBoxColorEl) state.settings.colors.shuruqBoxColor = shuruqBoxColorEl.value;
                if (clockBoxColorEl) state.settings.colors.clockBoxColor = clockBoxColorEl.value;
                if (jumuahBoxColorEl) state.settings.colors.jumuahBoxColor = jumuahBoxColorEl.value;
                if (prayerBoxesColorEl) state.settings.colors.prayerBoxesColor = prayerBoxesColorEl.value;
                
                // Audio
                const audioRef = document.getElementById('audioRef');
                if (audioRef) {
                    audioRef.volume = state.settings.volume;
                    audioRef.muted = state.settings.isMuted;
                }
                
                // Phases
                const adhanDurationMinutesEl = document.getElementById('adhan-duration-minutes');
                const adhanDurationSecondsEl = document.getElementById('adhan-duration-seconds');
                const adhanTextPositionEl = document.getElementById('adhan-text-position');
                const phoneImageDurationMinutesEl = document.getElementById('phone-image-duration-minutes');
                const phoneImageDurationSecondsEl = document.getElementById('phone-image-duration-seconds');
                const azkarDurationMinutesEl = document.getElementById('azkar-duration-minutes');
                const azkarDurationSecondsEl = document.getElementById('azkar-duration-seconds');
                
                if (adhanDurationMinutesEl) state.settings.adhanDurationMinutes = parseInt(adhanDurationMinutesEl.value) || 0;
                if (adhanDurationSecondsEl) state.settings.adhanDurationSeconds = parseInt(adhanDurationSecondsEl.value) || 0;
                if (adhanTextPositionEl) state.settings.adhanTextPosition = adhanTextPositionEl.value;
                if (phoneImageDurationMinutesEl) state.settings.phoneImageDurationMinutes = parseInt(phoneImageDurationMinutesEl.value) || 0;
                if (phoneImageDurationSecondsEl) state.settings.phoneImageDurationSeconds = parseInt(phoneImageDurationSecondsEl.value) || 0;
                if (azkarDurationMinutesEl) state.settings.azkarDurationMinutes = parseInt(azkarDurationMinutesEl.value) || 0;
                if (azkarDurationSecondsEl) state.settings.azkarDurationSeconds = parseInt(azkarDurationSecondsEl.value) || 0;
                
                // Save to localStorage - Ø­ÙØ¸ ÙƒØ§Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                const oldCountry = state.settings.country;
                const oldCity = state.settings.city;
                
                // ÙØµÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ø¹Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                const mediaFiles = {
                    backgroundImage: state.settings.backgroundImage || '',
                    iqamaBackgroundImage: state.settings.iqamaBackgroundImage || '',
                    azkarBackgroundImage: state.settings.azkarBackgroundImage || '',
                    phoneImage: state.settings.phoneImage || '',
                    adhanImage: state.settings.adhanImage || '',
                    adhanSound: state.settings.adhanSound || '',
                    fajrAdhanSound: state.settings.fajrAdhanSound || ''
                };
                
                // ÙØµÙ„ Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© Ø¹Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                const prayerTimesData = {
                    prayerTimes: state.settings.prayerTimes,
                    prayerTimeOffsets: state.settings.prayerTimeOffsets,
                    shuruqTime: state.settings.shuruqTime,
                    shuruqOffset: state.settings.shuruqOffset,
                    jumuahTime: state.settings.jumuahTime,
                    jumuahOffset: state.settings.jumuahOffset,
                    lastUpdated: new Date().toISOString()
                };

                // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ø¯ÙˆÙ† Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© ÙˆÙ…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©
                const essentialSettings = {
                    mosqueName: state.settings.mosqueName,
                    timeFormat: state.settings.timeFormat,
                    iqamaCountdown: state.settings.iqamaCountdown,
                    dimDuration: state.settings.dimDuration,
                    adhanDurationMinutes: state.settings.adhanDurationMinutes,
                    adhanDurationSeconds: state.settings.adhanDurationSeconds,
                    phoneImageDurationMinutes: state.settings.phoneImageDurationMinutes,
                    phoneImageDurationSeconds: state.settings.phoneImageDurationSeconds,
                    azkarDurationMinutes: state.settings.azkarDurationMinutes,
                    azkarDurationSeconds: state.settings.azkarDurationSeconds,
                    country: state.settings.country,
                    city: state.settings.city,
                    showWeather: state.settings.showWeather,
                    temperature: state.settings.temperature,
                    volume: state.settings.volume,
                    isMuted: state.settings.isMuted,
                    adhanTextPosition: state.settings.adhanTextPosition,
                    iqamaBackgroundColor: state.settings.iqamaBackgroundColor,
                    colors: state.settings.colors,
                    lastSaved: new Date().toISOString()
                };
                
                try {
                    // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                    localStorage.setItem('alMoazinClockSettings', JSON.stringify(essentialSettings));
                    console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙŠ localStorage');
                    console.log('ğŸ“‹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:', essentialSettings);
                } catch (e) {
                    console.error('âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:', e);
                    if (e.name === 'QuotaExceededError') {
                        alert('Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù…Ù…ØªÙ„Ø¦Ø©. ÙŠØ±Ø¬Ù‰ Ø­Ø°Ù Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØªØµÙØ­ Ø¢Ø®Ø±.');
                    } else {
                        alert('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                    }
                    return;
                }

                try {
                    // Ø­ÙØ¸ Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„
                    localStorage.setItem('alMoazinPrayerTimesData', JSON.stringify(prayerTimesData));
                    console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© ÙÙŠ localStorage');
                    console.log('ğŸ“‹ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:', prayerTimesData);
                } catch (e) {
                    console.error('âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©:', e);
                    // Ù„Ø§ Ù†ÙˆÙ‚Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¥Ø°Ø§ ÙØ´Ù„ Ø­ÙØ¸ Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©
                }
                
                try {
                    // Ø­ÙØ¸ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„ØµÙˆØ± - Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù†Ø­ÙØ¸ Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ©
                    localStorage.setItem('alMoazinMediaFiles', JSON.stringify(mediaFiles));
                    console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„ØµÙˆØ± ÙÙŠ localStorage:', {
                        hasBackgroundImage: !!mediaFiles.backgroundImage,
                        hasPhoneImage: !!mediaFiles.phoneImage,
                        hasAdhanImage: !!mediaFiles.adhanImage,
                        hasIqamaBackgroundImage: !!mediaFiles.iqamaBackgroundImage,
                        hasAzkarBackgroundImage: !!mediaFiles.azkarBackgroundImage,
                        hasAdhanSound: !!mediaFiles.adhanSound,
                        hasFajrAdhanSound: !!mediaFiles.fajrAdhanSound,
                        backgroundImageLength: mediaFiles.backgroundImage ? mediaFiles.backgroundImage.length : 0
                    });
                } catch (e) {
                    console.error('âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ù„ÙØ§Øª:', e);
                    if (e.name === 'QuotaExceededError') {
                        console.warn('âš ï¸ Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù…Ù…ØªÙ„Ø¦Ø© - Ù„Ù† ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„ÙØ§Øª Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø©');
                        alert('ØªØ­Ø°ÙŠØ±: Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù…Ù…ØªÙ„Ø¦Ø©. Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ù‚Ø¯ Ù„Ø§ ØªÙØ­ÙØ¸.');
                    }
                    // Ù„Ø§ Ù†ÙˆÙ‚Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¥Ø°Ø§ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ù„ÙØ§Øª
                }
                
                console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©...');
                
                closeSettings();
                renderMainScreen();
                
                // Fetch new prayer times if location changed
                const newCountry = state.settings.country;
                const newCity = state.settings.city;
                if (oldCountry !== newCountry || oldCity !== newCity) {
                    console.log('ğŸ“ ØªØºÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ - Ø¬Ù„Ø¨ Ù…ÙˆØ§Ù‚ÙŠØª Ø¬Ø¯ÙŠØ¯Ø©');
                    fetchPrayerTimesAndWeather(true);
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            }
        }

        // ==================== PRAYER TIMES FETCHING ====================
        async function fetchPrayerTimesAndWeather(force = false) {
            if (!state.settings.city || !state.settings.country) return;
            
            state.isFetchingTimes = true;
            state.isOffline = false;
            updateUI();
            
            const d = state.currentTime;
            const today = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            
            // Check cached data
            const storedTimesData = localStorage.getItem('alMoazinPrayerTimes');
            let useCachedData = false;
            
            if (storedTimesData && !force) {
                try {
                    const parsed = JSON.parse(storedTimesData);
                    const { date, times, shuruq, city, country, fetchTime } = parsed;
                    
                    const isToday = date === today;
                    const isSameLocation = city === state.settings.city && country === state.settings.country;
                    const fetchAge = Date.now() - (fetchTime || 0);
                    const maxAge = 6 * 60 * 60 * 1000;
                    const isDataFresh = fetchAge < maxAge;
                    
                    if (isToday && isSameLocation && isDataFresh && times) {
                        const offsets = state.settings.prayerTimeOffsets || { fajr: 0, dhuhr: 0, asr: 0, maghrib: 0, isha: 0 };
                        const adjustedTimes = {
                            fajr: applyOffsetToTime(times.fajr, offsets.fajr),
                            dhuhr: applyOffsetToTime(times.dhuhr, offsets.dhuhr),
                            asr: applyOffsetToTime(times.asr, offsets.asr),
                            maghrib: applyOffsetToTime(times.maghrib, offsets.maghrib),
                            isha: applyOffsetToTime(times.isha, offsets.isha),
                        };
                        const adjustedShuruq = applyOffsetToTime(shuruq, state.settings.shuruqOffset || 0);
                        
                        state.settings.prayerTimes = adjustedTimes;
                        state.settings.shuruqTime = adjustedShuruq;
                        state.settings.jumuahTime = adjustedTimes.dhuhr;
                        useCachedData = true;
                    }
                } catch (e) {
                    console.error('Error reading cached data:', e);
                }
            }
            
            if (useCachedData && !force) {
                state.isFetchingTimes = false;
                updateUI();
                return;
            }
            
            try {
                const locationMapping = resolveLocationMapping(state.settings.country, state.settings.city);
                const method = locationMapping.method ?? 23;
                const timezonestring = locationMapping.timeZone;
                const params = new URLSearchParams({
                    city: locationMapping.apiCity || state.settings.city,
                    country: locationMapping.apiCountry || state.settings.country,
                    method: String(method),
                });
                if (timezonestring) params.append('timezonestring', timezonestring);
                const url = `https://api.aladhan.com/v1/timingsByCity?${params.toString()}`;
                const resp = await fetch(url);
                if (!resp.ok) throw new Error(`Aladhan HTTP ${resp.status}`);
                const data = await resp.json();
                if (data.code !== 200 || !data.data?.timings) throw new Error('Invalid Aladhan response');
                const t = data.data.timings;
                const normalize = (v) => (v ? String(v).split(' ')[0] : '');
                const basePrayerTimes = {
                    fajr: normalize(t.Fajr),
                    dhuhr: normalize(t.Dhuhr),
                    asr: normalize(t.Asr),
                    maghrib: normalize(t.Maghrib),
                    isha: normalize(t.Isha),
                };
                const baseShuruq = normalize(t.Sunrise);
                const offsets = state.settings.prayerTimeOffsets || { fajr: 0, dhuhr: 0, asr: 0, maghrib: 0, isha: 0 };
                const newPrayerTimes = {
                    fajr: applyOffsetToTime(basePrayerTimes.fajr, offsets.fajr),
                    dhuhr: applyOffsetToTime(basePrayerTimes.dhuhr, offsets.dhuhr),
                    asr: applyOffsetToTime(basePrayerTimes.asr, offsets.asr),
                    maghrib: applyOffsetToTime(basePrayerTimes.maghrib, offsets.maghrib),
                    isha: applyOffsetToTime(basePrayerTimes.isha, offsets.isha),
                };
                const newShuruq = applyOffsetToTime(baseShuruq, state.settings.shuruqOffset || 0);
                
                state.settings.prayerTimes = newPrayerTimes;
                state.settings.shuruqTime = newShuruq;
                state.settings.jumuahTime = newPrayerTimes.dhuhr;
                
                const prayerData = {
                    date: today,
                    times: basePrayerTimes,
                    shuruq: baseShuruq,
                    adjustedTimes: newPrayerTimes,
                    adjustedShuruq: newShuruq,
                    city: state.settings.city,
                    country: state.settings.country,
                    temperature: state.settings.temperature,
                    method,
                    timezonestring,
                    fetchTime: Date.now(),
                    apiVersion: '1.0'
                };
                
                localStorage.setItem('alMoazinPrayerTimes', JSON.stringify(prayerData));
            } catch (error) {
                state.isOffline = true;
                console.error('Failed to fetch prayer times:', error);
            } finally {
                state.isFetchingTimes = false;
                updateUI();
                // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ«Ù‡Ø§
                startPrayerMonitoring();
            }
        }

        // ==================== EVENT LISTENERS ====================
        function setupEventListeners() {
            document.getElementById('save-settings').addEventListener('click', saveSettings);
            document.getElementById('update-prayer-times').addEventListener('click', async () => {
                const button = document.getElementById('update-prayer-times');
                const originalText = button.textContent;
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
                button.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«... ';
                button.disabled = true;
                
                try {
                    const success = await updatePrayerTimes();
                    if (success) {
                        button.textContent = 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­! ';
                        button.classList.remove('bg-secondary', 'text-secondary-foreground');
                        button.classList.add('bg-green-600', 'text-white');
                        
                        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†
                        setTimeout(() => {
                            button.textContent = originalText;
                            button.classList.remove('bg-green-600', 'text-white');
                            button.classList.add('bg-secondary', 'text-secondary-foreground');
                            button.disabled = false;
                        }, 2000);
                    } else {
                        button.textContent = 'ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«! ';
                        button.classList.remove('bg-secondary', 'text-secondary-foreground');
                        button.classList.add('bg-red-600', 'text-white');
                        
                        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†
                        setTimeout(() => {
                            button.textContent = originalText;
                            button.classList.remove('bg-red-600', 'text-white');
                            button.classList.add('bg-secondary', 'text-secondary-foreground');
                            button.disabled = false;
                        }, 2000);
                    }
                } catch (error) {
                    console.error('Error updating prayer times:', error);
                    button.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£! ';
                    button.classList.remove('bg-secondary', 'text-secondary-foreground');
                    button.classList.add('bg-red-600', 'text-white');
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove('bg-red-600', 'text-white');
                        button.classList.add('bg-secondary', 'text-secondary-foreground');
                        button.disabled = false;
                    }, 2000);
                }
            });
            document.getElementById('settings-overlay').addEventListener('click', closeSettings);
            
            // Audio unlock - ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø£ÙˆÙ„
            const audioRef = document.getElementById('audioRef');
            if (audioRef && !state.audioUnlocked) {
                const unlockAudio = async () => {
                    try {
                        console.log('ğŸ”“ Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª...');
                        audioRef.volume = 0;
                        const playPromise = audioRef.play();
                        if (playPromise) {
                            await playPromise;
                            audioRef.pause();
                            audioRef.currentTime = 0;
                            audioRef.volume = state.settings.volume;
                            state.audioUnlocked = true;
                            console.log('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¨Ù†Ø¬Ø§Ø­');
                        }
                    } catch (e) {
                        console.warn('âš ï¸ ÙØ´Ù„ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª:', e);
                    }
                };
                ['click', 'touchstart', 'keydown'].forEach(event => {
                    document.addEventListener(event, unlockAudio, { once: true });
                });
                console.log('ğŸ”“ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª...');
            } else if (audioRef && state.audioUnlocked) {
                console.log('âœ… Ø§Ù„ØµÙˆØª Ù…ÙØ¹Ù‘Ù„ Ø¨Ø§Ù„ÙØ¹Ù„');
            }
        }

        // ==================== TEST FUNCTIONS ====================
        function testAdhan(prayerName = 'maghrib') {
            console.log(`ğŸ§ª ğŸ§ª ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ø°Ø§Ù† Ù„ØµÙ„Ø§Ø© ${prayerNames[prayerName]} ğŸ§ª ğŸ§ª ğŸ§ª`);
            console.log('ğŸ“Š Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:', {
                currentPhase: state.currentPhase,
                activePrayer: state.activePrayer,
                isAdhanPlaying: state.isAdhanPlaying
            });
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø©
            state.currentPhase = 'idle';
            state.activePrayer = null;
            state.isAdhanPlaying = false;
            
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙØ¹Ù„Ø§Ù‹
            if (!state.audioUnlocked) {
                console.log('ğŸ”“ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª...');
                const audioRef = document.getElementById('audioRef');
                if (audioRef) {
                    try {
                        audioRef.volume = 0;
                        audioRef.play().then(() => {
                            audioRef.pause();
                            audioRef.currentTime = 0;
                            audioRef.volume = state.settings.volume;
                            state.audioUnlocked = true;
                            console.log('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª');
                            // Ø¨Ø¹Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØªØŒ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø£Ø°Ø§Ù†
                            setTimeout(() => {
                                state.activePrayer = prayerName;
                                state.currentPhase = 'adhan';
                                startAdhan();
                            }, 100);
                        }).catch((e) => {
                            console.warn('âš ï¸ ÙØ´Ù„ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª:', e);
                            // Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ØŒ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø£Ø°Ø§Ù†
                            state.activePrayer = prayerName;
                            state.currentPhase = 'adhan';
                            startAdhan();
                        });
                    } catch (e) {
                        console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª:', e);
                        state.activePrayer = prayerName;
                        state.currentPhase = 'adhan';
                        startAdhan();
                    }
                } else {
                    console.error('âŒ audioRef ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
                    state.activePrayer = prayerName;
                    state.currentPhase = 'adhan';
                    startAdhan();
                }
            } else {
                // Ø§Ù„ØµÙˆØª Ù…ÙØ¹Ù‘Ù„ Ø¨Ø§Ù„ÙØ¹Ù„
                state.activePrayer = prayerName;
                state.currentPhase = 'adhan';
                startAdhan();
            }
        }
        
        function showCurrentPrayerTimes() {
            console.log('ğŸ“‹ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:', state.settings.prayerTimes);
            console.log('â° Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ:', new Date().toLocaleTimeString('ar-SA'));
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            console.log('â° Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ (HH:MM):', currentTime);
        }

        // ==================== START APP ====================
        window.openSettings = openSettings;
        window.skipToNextPhase = skipToNextPhase;
        window.toggleAccordion = toggleAccordion;
        window.updateCities = updateCities;
        window.handleFileChange = handleFileChange;
        window.clearPhoneImage = clearPhoneImage;
        window.toggleMute = toggleMute;
        window.updateVolume = updateVolume;
        window.fetchPrayerTimes = fetchPrayerTimes;
        window.testAdhan = testAdhan;
        window.showCurrentPrayerTimes = showCurrentPrayerTimes;
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
